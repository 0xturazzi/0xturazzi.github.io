<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Stack Zero - Um Livrinho Sobre Exploit Dev</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <base href="../../">

        <link rel="stylesheet" href="book.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme -->
        

        

        <!-- Fetch Clipboard.js from CDN but have a local fallback -->
        <script src="https://cdn.jsdelivr.net/clipboard.js/1.6.1/clipboard.min.js"></script>
        <script>
            if (typeof Clipboard == 'undefined') {
                document.write(unescape("%3Cscript src='clipboard.min.js'%3E%3C/script%3E"));
            }
        </script>

        <!-- Fetch JQuery from CDN but have a local fallback -->
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script>
            if (typeof jQuery == 'undefined') {
                document.write(unescape("%3Cscript src='jquery.js'%3E%3C/script%3E"));
            }
        </script>

        <!-- Fetch store.js from local - TODO add CDN when 2.x.x is available on cdnjs -->
        <script src="store.js"></script>

    </head>
    <body class="light">
        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme = store.get('mdbook-theme');
            if (theme === null || theme === undefined) { theme = 'light'; }
            $('body').removeClass().addClass(theme);
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var sidebar = store.get('mdbook-sidebar');
            if (sidebar === "hidden") { $("html").addClass("sidebar-hidden") }
            else if (sidebar === "visible") { $("html").addClass("sidebar-visible") }
        </script>

        <div id="sidebar" class="sidebar">
            <ul class="chapter"><li><a href="./mapa.html"><strong>1.</strong> Mapa</a></li><li class="spacer"></li><li><a href="./stack/stack.html"><strong>2.</strong> Stack</a></li><li><a href="./stack/phoenix/setup.html"><strong>3.</strong> Phoenix Stack</a></li><li><ul class="section"><li><a href="./stack/phoenix/StackZero.html" class="active"><strong>3.1.</strong> Stack Zero</a></li><li><a href="./stack/phoenix/StackOne.html"><strong>3.2.</strong> Stack One</a></li><li><a href="./stack/phoenix/StackTwo.html"><strong>3.3.</strong> Stack Two</a></li><li><a href="./stack/phoenix/StackThree.html"><strong>3.4.</strong> Stack Three</a></li><li><a href="./stack/phoenix/StackFour.html"><strong>3.5.</strong> Stack Four</a></li><li><a href="./stack/phoenix/StackFive.html"><strong>3.6.</strong> Stack Five</a></li><li><a href="./stack/phoenix/StackSix.html"><strong>3.7.</strong> Stack Six</a></li></ul></li><li><a href="./stack/mitigacoes.html"><strong>4.</strong> Mitiga√ß√µes</a></li><li><a href="./stack/ret2libc.html"><strong>5.</strong> Ret2LibC</a></li><li><ul class="section"><li><strong>5.1.</strong> Protostar Stack Six</li><li><strong>5.2.</strong> Avan√ßado: M√∫ltiplos ret2libc</li></ul></li><li><a href="./stack/gotplt.html"><strong>6.</strong> GOT e PLT</a></li><li><a href="./stack/rop/intro.html"><strong>7.</strong> ROP</a></li><li><ul class="section"><li><a href="./stack/rop/primitivos.html"><strong>7.1.</strong> Primitivos</a></li><li><ul class="section"><li><a href="./stack/rop/ROPE/dump.html"><strong>7.1.1.</strong> ROPE</a></li></ul></li><li><strong>7.2.</strong> Pivot</li><li><ul class="section"><li><a href="./stack/rop/ROPE/pivot.html"><strong>7.2.1.</strong> ROPE: pivot</a></li></ul></li><li><a href="./stack/rop/SROP/SROP.html"><strong>7.3.</strong> SROP</a></li></ul></li><li><a href="./stack/ASLR/aslr.html"><strong>8.</strong> ASLR</a></li><li><ul class="section"><li><a href="./stack/ASLR/corromperGOT.html"><strong>8.1.</strong> Corromper GOT</a></li><li><a href="./stack/ASLR/ret2plt.html"><strong>8.2.</strong> ret2plt</a></li><li><a href="./stack/ASLR/brute32.html"><strong>8.3.</strong> Bruteforce</a></li></ul></li><li><strong>9.</strong> Canary</li><li><strong>10.</strong> PIE</li><li><a href="./stack/leakAll.html"><strong>11.</strong> Extra: Leakando tudo</a></li><li class="spacer"></li><li><a href="./heap/heap.html"><strong>12.</strong> Heap</a></li><li><a href="./heap/intro.html"><strong>13.</strong> Intro</a></li><li><strong>14.</strong> Bugs Gerais</li><li><ul class="section"><li><strong>14.1.</strong> UAF</li><li><ul class="section"><li><a href="./heap/geral/uaf/heap-two.html"><strong>14.1.1.</strong> Exploit Education: Heap Two</a></li></ul></li></ul></li><li><strong>15.</strong> Conceitos Relacionados</li><li><ul class="section"><li><strong>15.1.</strong> _IO_list_all</li></ul></li><li><strong>16.</strong> Atacando Malloc</li><li><ul class="section"><li><a href="./heap/basico/fastbinsDup.html"><strong>16.1.</strong> Fastbins Dup</a></li><li><a href="./heap/basico/HouseOfForce.html"><strong>16.2.</strong> House of Force</a></li><li><strong>16.3.</strong> Unsafe Unlink</li><li><strong>16.4.</strong> Safe Unlink</li><li><strong>16.5.</strong> Unsorted bins: Partial Unlink</li><li><strong>16.6.</strong> House of Spirit</li><li><strong>16.7.</strong> House of Orange</li><li><strong>16.8.</strong> House of Rust</li></ul></li><li><strong>17.</strong> Extra</li><li class="spacer"></li><li><a href="./linux_internals/linux.html"><strong>18.</strong> Linux Internals</a></li><li><a href="./linux_internals/prerequisitos.html"><strong>19.</strong> Prerequisitos</a></li></ul>
        </div>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page" tabindex="-1">
                
                <div id="menu-bar" class="menu-bar">
                    <div class="left-buttons">
                        <i id="sidebar-toggle" class="fa fa-bars" title="Toggle sidebar"></i>
                        <i id="theme-toggle" class="fa fa-paint-brush" title="Change theme"></i>
                    </div>

                    <h1 class="menu-title">Um Livrinho Sobre Exploit Dev</h1>

                    <div class="right-buttons">
                        <a href="print.html">
                            <i id="print-button" class="fa fa-print" title="Print this book"></i>
                        </a>
                    </div>
                </div>

                <div id="content" class="content">
                    <ul>
<li><a href="./stack/phoenix/StackZero.html#-descri%C3%A7%C3%A3o">üìù Descri√ß√£o</a></li>
<li><a href="./stack/phoenix/StackZero.html#-dica">üí° Dica</a></li>
<li><a href="./stack/phoenix/StackZero.html#conhecimento-preliminar">Conhecimento Preliminar</a>
<ul>
<li><a href="./stack/phoenix/StackZero.html#buffer">Buffer</a></li>
<li><a href="./stack/phoenix/StackZero.html#stack">Stack</a>
<ul>
<li><a href="./stack/phoenix/StackZero.html#a-stack-cresce-para-valores-menores">A stack cresce para valores menores</a></li>
<li><a href="./stack/phoenix/StackZero.html#hex">Hex</a></li>
<li><a href="./stack/phoenix/StackZero.html#melhorando-o-exemplo-do-po%C3%A7o">Melhorando o exemplo do po√ßo</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="./stack/phoenix/StackZero.html#-explica%C3%A7%C3%A3o">üéâ Explica√ß√£o</a>
<ul>
<li><a href="./stack/phoenix/StackZero.html#-1--alocando-as-vari%C3%A1veis-na-stack-buffer64-changeme">ü•û 1- Alocando as vari√°veis na stack (buffer[64], changeme)</a></li>
<li><a href="./stack/phoenix/StackZero.html#-2--alterar-buffer64-usando-gets">üí• 2- Alterar buffer[64] usando gets</a></li>
<li><a href="./stack/phoenix/StackZero.html#-3--o-programa-checa-se-changeme-foi-alterada">‚úÖ 3- O programa checa se changeme foi alterada</a>
<ul>
<li><a href="./stack/phoenix/StackZero.html#-64-as-changeme-n%C3%A3o-alterado">‚ùå 64 As, changeme n√£o alterado</a></li>
<li><a href="./stack/phoenix/StackZero.html#-65-as-changeme-alterado">‚úÖ 65 As, changeme alterado</a></li>
<li><a href="./stack/phoenix/StackZero.html#%EF%B8%8F-64-as-e-um-b-0x42-aaaaaaaaaaaab">üÖ±Ô∏è 64 As e um B (0x42): AAAAAAAAA.....AAAB</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="./stack/phoenix/StackZero.html#-solu%C3%A7%C3%A3o">üëæ Solu√ß√£o</a></li>
</ul>
<a class="header" href="./stack/phoenix/StackZero.html#-descri√ß√£o" id="-descri√ß√£o"><h1>üìù Descri√ß√£o</h1></a>
<p>Esse n√≠vel demonstra que memoria pode ser acessada fora da sua regi√£o
inicialmente alocada, como as vari√°veis s√£o alocadas na stack, e que altera-las pode mudar a execu√ß√£o do programa.</p>
<p>Objetivo: Alterar a vari√°vel &quot;changeme&quot;</p>
<a class="header" href="./stack/phoenix/StackZero.html#-dica" id="-dica"><h1>üí° Dica</h1></a>
<pre><code class="language-bash">$ python3 -c &quot;print('A' * 10)&quot;
AAAAAAAAAA

$ python3 -c &quot;print('A' * 10)&quot; | ./stack-zero 
</code></pre>
<a class="header" href="./stack/phoenix/StackZero.html#conhecimento-preliminar" id="conhecimento-preliminar"><h1>Conhecimento Preliminar</h1></a>
<a class="header" href="./stack/phoenix/StackZero.html#buffer" id="buffer"><h2>Buffer</h2></a>
<p>Buffers s√£o similares a arrays em outras linguagens de programa√ß√£o,
mas possuem tamanho fixo!</p>
<p>Eles s√£o definidos usando: <code>tipo nome[tamanho]</code></p>
<p>O <code>tipo</code>, √© do que esta sendo armazenado dentro, por exemplo:</p>
<pre><code class="language-C">char buf[64]; // Armazena 64 caracteres
int buf[32];  // Armazena 32 ints
</code></pre>
<p>Esses buffers por possu√≠rem tamanho fixo, s√£o armazenados na stack!</p>
<a class="header" href="./stack/phoenix/StackZero.html#stack" id="stack"><h2>Stack</h2></a>
<p>A stack √© uma por√ß√£o da memoria que armazena como se fosse uma pilha de pratos:</p>
<pre><code>Quando voc√™ quer colocar um novo, voc√™ coloca no topo da pilha (push)
Quando voc√™ quer pegar um da pilha, voc√™ pega o do topo (pop)

O ultimo a entrar, √© o primeiro a sair...
o nome desse comportamento √© LIFO (Last in First Out)
</code></pre>
<p><img src="./img/push-pop.png" alt="Imagem da wikipedia mostrando PUSH e POP" /></p>
<a class="header" href="./stack/phoenix/StackZero.html#a-stack-cresce-para-valores-menores" id="a-stack-cresce-para-valores-menores"><h3>A stack cresce para valores menores</h3></a>
<pre><code>Imagina que ela √© um po√ßo que come√ßa na profundidade 15

Quando voc√™ coloca um objeto de tamanho 2 no po√ßo:
ele vai estar apoiado na profundidade 15, e vai at√© a profundidade 13

Em seguida, voc√™ coloca algo de tamanho 3:
vai estar apoiado na profundidade 13, e vai at√© a profundidade 10
</code></pre>
<p>Conforme voc√™ vai <strong>adicionando</strong> itens, o endere√ßo que eles est√£o vai <strong>diminuindo</strong> em valor.
√â meio confuso, mas com o tempo voc√™ pega o jeito.</p>
<p>Pra complicar um pouco mais, esses endere√ßos t√£o em hexadecimal (0x0 ate 0xF, o &quot;0x&quot; √© pra representar que o valor t√° em hex).</p>
<a class="header" href="./stack/phoenix/StackZero.html#hex" id="hex"><h3>Hex</h3></a>
<p>Se vc n√£o souber hex: <a href="https://pt.wikipedia.org/wiki/Sistema_de_numera%C3%A7%C3%A3o_hexadecimal">Wikipedia Sistema de numera√ß√£o hexadecimal</a>
. Mas resumindo, em hex voc√™ conta:</p>
<pre><code>Hex: 0,1,2,...,8,9,A ,B ,C ,D ,E ,F ,10,11,12,...,19,1A,1B,1C,...,FF
Dec: 0,1,2,...,8,9,10,11,12,13,14,15,16,17,18,...,25,26,27,28,...,127
</code></pre>
<p>Ent√£o a base da stack √© 0xFFFFFFFF e o topo 0X00000000 !</p>
<a class="header" href="./stack/phoenix/StackZero.html#melhorando-o-exemplo-do-po√ßo" id="melhorando-o-exemplo-do-po√ßo"><h3>Melhorando o exemplo do po√ßo</h3></a>
<pre><code>0x0- 	     Topo da stack/Topo do po√ßo
0xA ate 0x1- espa√ßo vazio
0xD-         Segundo item
0xF-         Base da stack/Fundo do po√ßo, primeiro item
</code></pre>
<a class="header" href="./stack/phoenix/StackZero.html#-explica√ß√£o" id="-explica√ß√£o"><h1>üéâ Explica√ß√£o</h1></a>
<p>A fun√ß√£o main() pode estar sendo divida em 3 Partes:</p>
<ol>
<li>ü•û Alocando as vari√°veis na stack (buffer[64], changeme)</li>
<li>üí• Alterar buffer[64] usando gets()</li>
<li>‚úÖ Checando se changeme foi alterada</li>
</ol>
<pre><code class="language-C">int main(int argc, char **argv) {
            // Definir vari√°veis locais
  struct {
    char buffer[64];
    volatile int changeme;
  } locals;

  printf(&quot;%s\n&quot;, BANNER); // Printar o banner (todo n√≠vel faz isso)

  locals.changeme = 0;
  gets(locals.buffer);   // Alterar o buffer

  if (locals.changeme != 0) { 	// Checar se changeme foi alterada
    puts(&quot;Well done, the 'changeme' variable has been changed!&quot;);
  } else {
    puts(&quot;Uh oh, 'changeme' has not yet been changed&quot;);
  }

  exit(0);
}
</code></pre>
<p>Ue, <code>changeme</code> nunca foi alterada... Ela n√£o deveria estar mudando!</p>
<p>Calma que voc√™ ja vai entender :)</p>
<a class="header" href="./stack/phoenix/StackZero.html#-1--alocando-as-vari√°veis-na-stack-buffer64-changeme" id="-1--alocando-as-vari√°veis-na-stack-buffer64-changeme"><h2>ü•û 1- Alocando as vari√°veis na stack (buffer[64], changeme)</h2></a>
<p>A vari√°vel <code>buffer[64]</code> tem  tamanho de 64 bytes (64 letras, assumindo ASCII, um byte por letra).</p>
<p>A vari√°vel <code>changeme</code> esta marcada como <code>vol√°til</code> para prevenir que o compilador
destrua ela (pq originalmente n√£o seria
alterada, ent√£o seria destru√≠da para otimizar o c√≥digo...
Mas n√≥s vamos alterar ela por m√©todos... ~risada mal√©fica~ ... n√£o convencionais hehehe).</p>
<p>Nossas duas vari√°veis (buffer[64] e changeme) s√£o empurradas na stack.</p>
<pre><code>buffer[64] (preenchido com zeros (vazio))
changeme   (com o valor: 0x00)
ret        - Base dessa stack
</code></pre>
<a class="header" href="./stack/phoenix/StackZero.html#-2--alterar-buffer64-usando-gets" id="-2--alterar-buffer64-usando-gets"><h2>üí• 2- Alterar buffer[64] usando gets</h2></a>
<p>A fun√ß√£o <code>gets()</code> abre um input no terminal, e escreve o que recebeu no <code>buffer</code>.</p>
<p>O problema √© que ela <strong>n√£o</strong> checa se o valor recebido √© maior que o <code>buffer</code>, permitindo que
voc√™ <strong>escreva fora do buffer!!</strong> D:</p>
<p>Ela vai come√ßar a escrever no topo do buffer (menor endere√ßo)
e vai descendo at√© a base da stack.</p>
<pre><code>**Stack**
buffer
       [
A           | Gets escreve nesse sentido
A           |
A           \/
...
A
      ]
changeme (com valor 0x00)
ret       - Base dessa stack
</code></pre>
<p>Ent√£o, caso coloc√°ssemos 100 &quot;A&quot;s no buffer de tamanho 64, as vari√°veis nos pr√≥ximos 36 endere√ßos seriam alteradas.</p>
<p>Essas vari√°veis ficariam com o valor &quot;41&quot;, mas pq 41?</p>
<p>O valor ASCII do &quot;A&quot; √© 0x41, voc√™ pode checar o de todas letras usando:</p>
<blockquote>
<p>$ man ascii</p>
</blockquote>
<p>Ui, o usu√°rio pode escrever fora memoria dele? perigoso ne! D:</p>
<p>√â por isso que essa fun√ß√£o est√° marcada como <em>Deprecated</em> (fora de uso).</p>
<p>No nosso caso, o buffer tem o tamanho de <strong>64</strong> bytes, se colocarmos <strong>65</strong> &quot;A&quot;s (65 bytes), o valor vai vazar desse buffer.
Isso quer dizer que antes a vari√°vel <code>changeme</code> tinha o valor <strong>0x00</strong> e agora tem o valor <strong>0x41</strong> !</p>
<pre><code>**Stack**
buffer
      [
41           | Gets escreve nesse sentido
41           |
41           \/
...
41
      ]
changeme (com o valor: 41)
ret       - Base dessa stack
</code></pre>
<a class="header" href="./stack/phoenix/StackZero.html#-3--o-programa-checa-se-changeme-foi-alterada" id="-3--o-programa-checa-se-changeme-foi-alterada"><h2>‚úÖ 3- O programa checa se changeme foi alterada</h2></a>
<p>Se foi alterada, quer dizer que a gente <em>overflow-ou</em> (escreveu fora) do buffer, √© vitoria!!! :D</p>
<p>Ta, mas como a gente faz isso na pr√°tica?</p>
<p><code>python3 -c &quot;print(&quot;A&quot;*65)&quot;</code> printa 65 &quot;A&quot;s para o terminal</p>
<p>Ent√£o se a gente encaminhar esses &quot;A&quot;s pro programa....</p>
<pre><code>Se voc√™ quer tentar resolver sozinhe, agora √© a sua hora!

.
.
.
.
</code></pre>
<a class="header" href="./stack/phoenix/StackZero.html#-64-as-changeme-n√£o-alterado" id="-64-as-changeme-n√£o-alterado"><h3>‚ùå 64 As, changeme n√£o alterado</h3></a>
<pre><code class="language-bash">$ python3 -c &quot;print('A' * 64)&quot; | ./stack-zero 
Banner
Uh oh, 'changeme' has not yet been changed.
Would you like to try again?
</code></pre>
<a class="header" href="./stack/phoenix/StackZero.html#-65-as-changeme-alterado" id="-65-as-changeme-alterado"><h3>‚úÖ 65 As, changeme alterado</h3></a>
<pre><code class="language-bash">$ python3 -c &quot;print('A' * 65)&quot; | ./stack-zero 
Banner
Well done, the 'changeme' variable has been changed!
</code></pre>
<a class="header" href="./stack/phoenix/StackZero.html#üÖ±-64-as-e-um-b-0x42-aaaaaaaaaaaab" id="üÖ±-64-as-e-um-b-0x42-aaaaaaaaaaaab"><h3>üÖ±Ô∏è 64 As e um B (0x42): AAAAAAAAA.....AAAB</h3></a>
<p>Para demonstrar melhor esse comportamento do buffer
ser escrito em um sentido espec√≠fico (pq vai ser muito importante saber disso),
vou dar outro exemplo:
<code>python3 -c &quot;print('A' * 64 + 'B')&quot;</code></p>
<pre><code class="language-md">buffer [
41           | Gets escreve nesse sentido
41           |
41           \/
...
41
       ]
changeme (com o valor: 42)   &lt;- B = 42!!!!
ret       - Base dessa stack
</code></pre>
<p>Os <code>A</code>s preenchem certinho a stack, e a gente pode colocar o valor que quiser na vari√°vel!! Uhhuuu :D</p>
<p>Esses As s√≥ pra encher a stack s√£o chamados de <code>padding</code> (traduz pra preenchimento).</p>
<hr />
<p>Fim! :D</p>
<p>Ouch... isso foi um bocado de explica√ß√£o, mas relaxa que daqui pra frente fica mais dif√≠cil hehehe :D</p>
<p>Se voc√™ chegou at√© aqui, voc√™ ta de parab√©ns !!!</p>
<p>Pra lembrar bem, desenha uma stack no papel, da um push nas vari√°veis e no buffer, mostra o sentido que o
buffer escreve, e ele vazando e mudando o valor das outras vari√°veis...</p>
<a class="header" href="./stack/phoenix/StackZero.html#-solu√ß√£o" id="-solu√ß√£o"><h1>üëæ Solu√ß√£o</h1></a>
<pre><code class="language-bash">$ python3 -c &quot;print('A' * 65)&quot; | ./stack-zero
Welcome to phoenix/stack-zero, brought to you 
by https://exploit.education
Well done, the 'changeme' variable has been changed!
</code></pre>

                </div>

                <!-- Mobile navigation buttons -->
                
                    <a rel="prev" href="./stack/phoenix/setup.html" class="mobile-nav-chapters previous" title="Previous chapter">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="./stack/phoenix/StackOne.html" class="mobile-nav-chapters next" title="Next chapter">
                        <i class="fa fa-angle-right"></i>
                    </a>
                

            </div>

            
                <a href="./stack/phoenix/setup.html" class="nav-chapters previous" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-left"></i>
                </a>
            

            
                <a href="./stack/phoenix/StackOne.html" class="nav-chapters next" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-right"></i>
                </a>
            

        </div>


        <!-- Local fallback for Font Awesome -->
        <script>
            if ($(".fa").css("font-family") !== "FontAwesome") {
                $('<link rel="stylesheet" type="text/css" href="_FontAwesome/css/font-awesome.css">').prependTo('head');
            }
        </script>

        <!-- Livereload script (if served using the cli tool) -->
        

        

        

        

        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS script -->
        

    </body>
</html>
