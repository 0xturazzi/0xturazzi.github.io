<!DOCTYPE HTML>
<html lang="pt-br" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ROP - Um Livrinho Sobre Exploit Dev</title>
        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="../../mapa.html">Mapa</a></li><li class="spacer"></li><li class="chapter-item "><a href="../../stack/stack.html">Stack</a></li><li class="chapter-item "><a href="../../stack/phoenix/setup.html">Phoenix Stack</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../stack/phoenix/StackZero.html">Stack Zero</a></li><li class="chapter-item "><a href="../../stack/phoenix/StackOne.html">Stack One</a></li><li class="chapter-item "><a href="../../stack/phoenix/StackTwo.html">Stack Two</a></li><li class="chapter-item "><a href="../../stack/phoenix/StackThree.html">Stack Three</a></li><li class="chapter-item "><a href="../../stack/phoenix/StackFour.html">Stack Four</a></li><li class="chapter-item "><a href="../../stack/phoenix/StackFive.html">Stack Five</a></li><li class="chapter-item "><a href="../../stack/phoenix/StackSix.html">Stack Six</a></li></ol></li><li class="chapter-item "><a href="../../stack/mitigacoes.html">Mitigações</a></li><li class="chapter-item "><a href="../../stack/ret2libc.html">Ret2LibC</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><div>Protostar Stack Six</div></li><li class="chapter-item "><div>Avançado: Múltiplos ret2libc</div></li></ol></li><li class="chapter-item "><a href="../../stack/gotplt.html">GOT e PLT</a></li><li class="chapter-item expanded "><a href="../../stack/rop/intro.html" class="active">ROP</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../stack/rop/primitivos.html">Primitivos</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../stack/rop/ROPE/dump.html">ROPE</a></li></ol></li><li class="chapter-item "><div>Pivot</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../stack/rop/ROPE/pivot.html">ROPE: pivot</a></li></ol></li><li class="chapter-item "><a href="../../stack/rop/SROP/SROP.html">SROP</a></li><li class="chapter-item "><a href="../../stack/rop/ret2dlresolve.html">ret2dl-resolve</a></li></ol></li><li class="chapter-item "><a href="../../stack/ASLR/aslr.html">ASLR</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../stack/ASLR/corromperGOT.html">Corromper GOT</a></li><li class="chapter-item "><a href="../../stack/ASLR/ret2plt.html">ret2plt</a></li><li class="chapter-item "><a href="../../stack/ASLR/brute32.html">Bruteforce</a></li></ol></li><li class="chapter-item "><div>Canary</div></li><li class="chapter-item "><div>PIE</div></li><li class="chapter-item "><a href="../../stack/leakAll.html">Extra: Leakando tudo</a></li><li class="spacer"></li><li class="chapter-item "><a href="../../heap/heap.html">Heap</a></li><li class="chapter-item "><a href="../../heap/intro.html">Intro</a></li><li class="chapter-item "><div>Bugs Gerais</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><div>UAF</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../heap/geral/uaf/heap-two.html">Exploit Education: Heap Two</a></li></ol></li></ol></li><li class="chapter-item "><a href="../../heap/relacionados/relacionados.html">Conceitos Relacionados</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../heap/relacionados/io_list_all.html">_IO_list_all</a></li></ol></li><li class="chapter-item "><a href="../../heap/malloc/intro.html">Atacando Malloc</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../heap/malloc/teoria.html">Teoria</a></li><li class="chapter-item "><a href="../../heap/malloc/fastbinsDup.html">Fastbins Dup</a></li><li class="chapter-item "><a href="../../heap/malloc/HouseOfForce.html">House of Force</a></li><li class="chapter-item "><a href="../../heap/malloc/HouseOfSpirit.html">House of Spirit</a></li><li class="chapter-item "><a href="../../heap/malloc/unsafeUnlink.html">Unsafe Unlink</a></li><li class="chapter-item "><a href="../../heap/malloc/safeUnlink.html">Safe Unlink</a></li><li class="chapter-item "><a href="../../heap/malloc/HouseOfEinherjar.html">House of Einherjar</a></li><li class="chapter-item "><a href="../../heap/malloc/GooglePoisonNull.html">Google Poison Null Byte</a></li><li class="chapter-item "><a href="../../heap/malloc/PartialUnlink.html">Unsorted bins: Partial Unlink</a></li><li class="chapter-item "><a href="../../heap/malloc/HouseOfOrange.html">House of Orange</a></li><li class="chapter-item "><a href="../../heap/malloc/comboFastUnsorted.html">Combo: Fast+Unsorted</a></li><li class="chapter-item "><a href="../../heap/malloc/HouseOfLore.html">House of Lore</a></li><li class="chapter-item "><div>House of Rust</div></li><li class="chapter-item "><a href="../../heap/malloc/HouseOfRabbit.html">House of Rabbit</a></li><li class="chapter-item "><div>House of Corrosion</div></li><li class="chapter-item "><div>House of Red</div></li><li class="chapter-item "><a href="../../heap/malloc/tcachedup.html">TCache Dup</a></li></ol></li><li class="chapter-item "><div>Extra</div></li><li class="spacer"></li><li class="chapter-item "><a href="../../linux_internals/linux.html">Linux Internals</a></li><li class="chapter-item "><a href="../../linux_internals/prerequisitos.html">Prerequisitos</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Um Livrinho Sobre Exploit Dev</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/0xturazzi/Um-Livrinho-Sobre-Exploit-Dev/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="intro-rop"><a class="header" href="#intro-rop">Intro ROP</a></h1>
<ul>
<li><a href="#intro-rop">Intro ROP</a></li>
<li><a href="#teoria">Teoria</a>
<ul>
<li><a href="#ret">Ret</a></li>
<li><a href="#gadgets">Gadgets</a></li>
<li><a href="#chains">Chains</a></li>
</ul>
</li>
<li><a href="#ferramentas">Ferramentas</a></li>
<li><a href="#curiosidades">Curiosidades</a></li>
</ul>
<p>ROP (programação orientada ao retorno) foi um técnica desenvolvida 
para burlar todas as limitações e mecanismos de segurança 
impostos no <code>RIP</code>!</p>
<p>Vamos considerar que todas mitigações exceto <code>PIE</code> estão ativas!</p>
<h1 id="teoria"><a class="header" href="#teoria">Teoria</a></h1>
<h2 id="ret"><a class="header" href="#ret">Ret</a></h2>
<p>O que faz o <code>RIP</code> ser especial? Em um nível abstrato, quais sao 
suas propriedades genéricas que o dao sua funcionalidade??</p>
<ul>
<li>[1] ~ O RIP aponta para um endereço na memoria</li>
<li>[2] ~ Em seguida, ele age com base no valor presente</li>
<li>[3] ~ Ele automaticamente avança (aumenta seu endereço)</li>
<li>[4] ~ jmp [1]</li>
</ul>
<p>Existe algum outro que possa operar dessa maneira? Sim! o <code>RSP</code>! </p>
<p>Quando o processador executa <code>RET</code>, o endereço no topo da stack 
(aonde <code>RSP</code> aponta) sera colocado no <code>RIP</code> e o <code>RSP</code> se ajusta: 
<code>RSP += 8</code>! :D</p>
<h2 id="gadgets"><a class="header" href="#gadgets">Gadgets</a></h2>
<p>Um gadget consiste em uma sequencia de instruções, seguidas de um 
<code>RET</code>. Por exemplo:</p>
<pre><code class="language-x86asm">gadget_1:
    mov rax rbx
    mov r12 r13
    ret

gadget_2:
    pop rdi
    pop rbp
    ret

</code></pre>
<p>Vamos supor que apos um BoF, o <code>RIP</code> salvo esta num offset de 40.</p>
<pre><code class="language-py">payload = b&quot;A&quot; * 40
payload += gadget_1
payload += b&quot;B&quot; * 8
</code></pre>
<p>Quando a função vulnerável retornar, o valor no topo da stack sera 
<code>&amp;gadget_1</code></p>
<pre><code class="language-x86asm">vulnerável:             stack:
    ...                 AAAAAAAA
    leave               ...
    ret     &lt;- RIP      AAAAAAAA
                        gadget_1 &lt;- RSP
                        BBBBBBBB


A execução sera redirecionada, e o RSP ira avançar


gadget_1:               stack:
    mov rax rbx &lt;- RIP  AAAAAAAA
    mov r12 r13         ...
    ret                 AAAAAAAA
                        gadget_1
                        BBBBBBBB &lt;- RSP

As duas instruções serão executadas!

gadget_1:               stack:
    mov rax rbx         AAAAAAAA
    mov r12 r13         ...
    ret     &lt;- RIP      AAAAAAAA
                        gadget_1
                        BBBBBBBB &lt;- RSP

E agora, a funcao retornara para BBBBBBBB, um endereço invalido, gerando uma SEGFAULT
</code></pre>
<p>E caso a instrução seja um  <code>POP</code>? o <code>RSP</code> andaria? Sim, e precisamos levar 
isso em consideração</p>
<pre><code class="language-py">payload = b&quot;A&quot; * 40
payload += gadget_2
payload += b&quot;T&quot; * 8 # RDI
payload += b&quot;Y&quot; * 8 # RBP
payload += b&quot;B&quot; * 8 # RET
</code></pre>
<p>E vamos supor que os registers sao inicializados com <code>OOOOOOOO</code></p>
<pre><code class="language-x86asm">vulnerável:             stack:              
    ...                 AAAAAAAA
    leave               ...
    ret     &lt;- RIP      AAAAAAAA
                        gadget_2 &lt;- RSP
                        TTTTTTTT
                        YYYYYYYY
                        BBBBBBBB


A execução sera redirecionada, e o RSP ira avançar !
Ate aqui foi igual ao anterior!

gadget_2:               stack:              registers:
    pop rdi &lt;- RIP      AAAAAAAA                RDI = OOOOOOOO    
    pop rbp             ...                     RBP = OOOOOOOO
    ret                 AAAAAAAA
                        gadget_2
                        TTTTTTTT &lt;- RSP
                        YYYYYYYY 
                        BBBBBBBB

pop rdi sera executado, salvando o valor no topo da stack em RDI e avançando RSP

gadget_2:               stack:              registers:
    pop rdi             AAAAAAAA                RDI = TTTTTTTT    
    pop rbp &lt;- RIP      ...                     RBP = OOOOOOOO
    ret                 AAAAAAAA
                        gadget_2
                        TTTTTTTT 
                        YYYYYYYY &lt;- RSP
                        BBBBBBBB


pop rbp sera executado, salvando o valor no topo da stack em RBP e avançando RSP

gadget_2:               stack:              registers:
    pop rdi             AAAAAAAA                RDI = TTTTTTTT    
    pop rbp             ...                     RBP = YYYYYYYY
    ret     &lt;- RIP      AAAAAAAA
                        gadget_2
                        TTTTTTTT 
                        YYYYYYYY
                        BBBBBBBB &lt;- RSP

E agora, a funcao retornara para BBBBBBBB, um endereço invalido, gerando uma SEGFAULT
</code></pre>
<h2 id="chains"><a class="header" href="#chains">Chains</a></h2>
<p>E se, ao invés de retornarmos para <code>BBBBBBBB</code>, retornássemos para outro gadget? </p>
<p>Seria tipo uma corrente: </p>
<p>___com um gadget executando e redirecionando para o proximo....</p>
<p>___com um gadget executando e redirecionando para o proximo....</p>
<p>___com um gadget executando e redirecionando para o proximo....</p>
<p>___com um gadget executando e redirecionando para o proximo....</p>
<p>Assim, poderíamos devagarinho reconstruir o nosso shellcode, a partir de partes 
pre-existentes do código!</p>
<p>E como <code>PIE</code> esta desativado, a secao de código do binário NAO tem seu 
endereço randomizado!</p>
<blockquote>
<p>OBS: Voce nao pode usar a secao de código do libc como gadgets, pois ele tem 
o endereço randomizado (ASLR)</p>
</blockquote>
<pre><code class="language-x86asm">gadget_1:
    mov rax rbx
    mov r12 r13
    ret

gadget_2:
    pop rdi
    pop rbp
    ret
</code></pre>
<pre><code class="language-py">payload = b&quot;A&quot; * 40
payload += gadget_1
payload += gadget_2 
payload += b&quot;T&quot; * 8 # RDI
payload += b&quot;Y&quot; * 8 # RBP
payload += gadget_1
payload += gadget_1
payload += gadget_1
payload += gadget_2 
payload += b&quot;T&quot; * 8 # RDI
payload += b&quot;Y&quot; * 8 # RBP
payload += gadget_1
payload += b&quot;B&quot; * 8 # SEGFAULT
</code></pre>
<p>Essa chain em especifico nao faz nada de util, somente demonstrar como chains 
podem ser construidas!</p>
<p>Numa situação real nao teríamos uma <code>SEGFAULT</code> no final, pois ja teríamos uma 
shell antes de chegar a esse ponto!</p>
<h1 id="ferramentas"><a class="header" href="#ferramentas">Ferramentas</a></h1>
<p>Existem múltiplas ferramentas capazes de encontrar gadgets e ate gerar chains 
automaticamente!</p>
<p>Eu recomendo voce testar e ver o que prefere!</p>
<ul>
<li><a href="https://github.com/Boyan-MILANOV/ropium">ropium</a></li>
<li><a href="https://github.com/sashs/Ropper">ropper</a></li>
<li><a href="https://github.com/JonathanSalwan/ROPgadget">ropGadget</a></li>
<li><a href="https://docs.pwntools.com/en/latest/rop.html">O submodulo do pwntools</a></li>
</ul>
<hr />
<p>E enquanto eu pegava os links no github..
eu encontrei esse em rust:
<a href="https://github.com/Ben-Lichtman/ropr/tree/master/src">ropr</a></p>
<p>Que parece ser bem interessante, mas ainda vou testar!</p>
<hr />
<p>Todas as ferramentas possuem funcionalidade de filtrar gadgets com badchars, 
automaticamente gerar chains...</p>
<p>Eu pessoalmente gosto de ropper e do pwntools (pq ter tudo dentro do mesmo 
framework == incrível)</p>
<h1 id="curiosidades"><a class="header" href="#curiosidades">Curiosidades</a></h1>
<p>Em arquiteturas <code>RISC</code>, todas as instruções tem o mesmo tamanho (em bytes)...</p>
<p>Porem em <code>x86</code> (<code>CISC</code>), as instruções podem desde 2 bytes, ate 5/6/7 bytes!</p>
<p>Assim, as ferramentas que encontram gadgets podem criar instruções que 
originalmente nao existiam no programa!</p>
<pre><code>Exemplo (fictício, pq eu to com preguiça ler o manual e ver os bytecodes)

O programa originalmente ve:

12 34   56 78 91    12 34  90
|       |           |      |
Add     Pop         Add    NOP

Porem, a ferramenta pode escolher um offset com alinhamento diferente do anterior:

12      34 56 78    91 12   34 90
|       |           |       |
AND     Sub         Push    XOR

Mesmos bytes, instruções diferentes

</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../stack/gotplt.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../../stack/rop/primitivos.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../stack/gotplt.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../stack/rop/primitivos.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
